<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE COLLECTION | 原创角色展示</title>
    
    <!-- Tailwind CSS 核心库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 【设置】Tailwind 全局配置
        tailwind.config = {
            theme: {
                extend: {
                    // 继承原项目的动画
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    // SSIS 后台界面的颜色定义
                    colors: {
                        'primary-blue': '#4f46e5', // Indigo-600 for official tone
                        'bg-light': '#f9fafb',    // Light background from original
                    },
                }
            }
        }
    </script>
    
    <!-- Three.js 3D库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Noto+Serif+SC:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- SSIS 额外字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <!-- 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ============================= */
        /* === MY UNIVERSE CORE STYLES === */
        /* ============================= */
        body {
            font-family: 'Lato', sans-serif;
            overflow: hidden; 
            background-color: #f9f9f9;
        }
        
        section, footer {
            scroll-snap-align: start;
        }

        h1, h2, h3, .font-serif {
            font-family: 'Playfair Display', serif;
        }

        .font-reading {
            font-family: 'Noto Serif SC', serif;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ... (基础动画样式省略, 保持不变) ... */
        .image-reveal { opacity: 0; transform: scale(1.05); transition: opacity 1.5s ease-out, transform 1.5s ease-out; }
        .image-reveal.loaded { opacity: 1; transform: scale(1); }
        #modal-overlay { transition: opacity 0.5s ease; }
        #modal-content { transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s ease; }
        @keyframes particle-dissolve { 0% { opacity: 1; filter: blur(0px); transform: scale(1); letter-spacing: normal; } 100% { opacity: 0; filter: blur(12px); transform: scale(1.1) translateY(-15px); letter-spacing: 0.3em; } }
        @keyframes particle-assemble { 0% { opacity: 0; filter: blur(15px); transform: scale(0.95) translateY(15px); letter-spacing: 0.3em; } 50% { opacity: 0.5; filter: blur(4px); letter-spacing: 0.1em; } 100% { opacity: 1; filter: blur(0px); transform: scale(1) translateY(0); letter-spacing: normal; } }
        .image-fade-out { animation: fade-out 0.8s forwards; }
        .image-fade-in { animation: fade-in 1.2s forwards; }
        @keyframes fade-out { from { opacity: 1; } to { opacity: 0; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        #reading-mode { transition: opacity 0.5s ease, transform 0.5s ease; }
        #toc-sidebar { transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        #canvas-container { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; overflow: hidden; background: transparent; pointer-events: none; }
        .scroll-indicator { animation: bounce 3s infinite; } 
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        .reveal-on-scroll { opacity: 0; transform: translateY(40px); transition: opacity 1.6s cubic-bezier(0.22, 1, 0.36, 1), transform 1.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .reveal-on-scroll.visible { opacity: 1; transform: translateY(0); }
        .music-playing { animation: spin-slow 6s linear infinite; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #toast-notification { transition: opacity 0.5s ease, transform 0.5s ease; z-index: 110; }
        #toast-notification.show { opacity: 1; transform: translate(-50%, 0); }
        #toast-notification.hide { opacity: 0; transform: translate(-50%, 20px); pointer-events: none; }
        #carousel-track { perspective: 1200px; transform-style: preserve-3d; }
        .carousel-item { position: absolute; top: 50%; left: 50%; transform-origin: center center; transition: transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.8s cubic-bezier(0.25, 0.8, 0.25, 1), filter 0.8s ease, z-index 0s linear 0.2s; will-change: transform, opacity, filter; transform-style: preserve-3d; cursor: pointer; }
        .carousel-center { z-index: 30; transform: translate3d(-50%, -50%, 0) scale(1) rotateY(0deg); opacity: 1; filter: brightness(1) blur(0px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .carousel-left { z-index: 20; transform: translate3d(-110%, -50%, -250px) scale(0.9) rotateY(25deg); opacity: 0.7; filter: brightness(0.5) blur(3px); }
        .carousel-right { z-index: 20; transform: translate3d(10%, -50%, -250px) scale(0.9) rotateY(-25deg); opacity: 0.7; filter: brightness(0.5) blur(3px); }
        .carousel-hidden { z-index: 10; transform: translate3d(-50%, -50%, -500px) scale(0.5); opacity: 0; filter: brightness(0) blur(10px); pointer-events: none; }
        @media (max-width: 768px) { #carousel-track { perspective: 800px; } .carousel-left { transform: translate3d(-100%, -50%, -150px) scale(0.85) rotateY(15deg); } .carousel-right { transform: translate3d(0%, -50%, -150px) scale(0.85) rotateY(-15deg); } .carousel-center { box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.3); } }

        /* ======================== */
        /* === SSIS BACKEND STYLES === */
        /* ======================== */
        .ssis-body {
            font-family: 'Lato', 'Noto Sans SC', system-ui, sans-serif;
            background-color: #f4f4f5; 
        }
        
        /* 后台滚动条样式 */
        .backend-scroll::-webkit-scrollbar { width: 6px; }
        .backend-scroll::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
        .backend-scroll::-webkit-scrollbar-track { background-color: transparent; }

        /* 学生卡专用样式 */
        .student-id-card {
            aspect-ratio: 4 / 3; 
            max-width: 450px; 
            background: linear-gradient(135deg, #ffffff 0%, #f7f7fc 100%);
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .student-id-photo {
            object-fit: cover;
            object-position: top center;
        }
        
        /* 档案详情样式 */
        .dossier-item {
            display: grid;
            grid-template-columns: 1fr 2fr;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        /* 模态框动画 */
        #report-modal-overlay { transition: opacity 0.3s ease; }
        #report-modal-content { transition: transform 0.3s ease-out, opacity 0.3s ease; }
        
        /* SSIS 主模态框动画 */
        #ssis-modal-overlay {
            transition: opacity 0.5s ease;
            z-index: 99; /* 确保它在主页内容之上，但在其他模态框之下 */
        }
    </style>
</head>
<body class="antialiased bg-[#f9f9f9] text-[#333] transition-colors duration-1000"> 

    <audio id="bgm" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3" type="audio/mpeg">
    </audio>

    <!-- 导航栏 -->
    <nav class="fixed top-0 w-full z-40 bg-white/80 backdrop-blur-md border-b border-gray-100 transition-colors duration-500">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="text-xl font-serif font-semibold tracking-widest text-[#333]">MY COLLECTION</div>
            <div class="flex items-center gap-4 md:gap-6">
                <div class="hidden md:flex space-x-8 text-sm uppercase tracking-wide text-gray-500">
                    <button onclick="customSmoothScroll('world-section')" class="hover:text-black transition-colors uppercase">World</button>
                    <button onclick="customSmoothScroll('gallery-section')" class="hover:text-black transition-colors uppercase">Settings</button>
                    <button onclick="customSmoothScroll('stories-section')" class="hover:text-black transition-colors uppercase">Stories</button>
                    <!-- 移除了后台管理系统链接 -->
                </div>
                <!-- 音乐切换按钮 -->
                <div class="flex items-center gap-2 pl-0 ml-0">
                    <button id="music-toggle" onclick="toggleMusic()" class="p-2 rounded-full hover:bg-gray-200 transition-colors text-gray-600 group relative">
                        <i id="icon-music" data-lucide="music" class="w-5 h-5"></i>
                        <span id="music-wave" class="absolute inset-0 rounded-full border border-gray-400 opacity-0 transition-opacity duration-700"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主滚动容器 -->
    <main id="scroll-container" class="h-screen w-full overflow-y-scroll snap-y snap-mandatory relative no-scrollbar">
        
        <!-- 第一屏：World (Three.js 动态背景) -->
        <section id="world-section" class="relative h-screen w-full flex flex-col items-center justify-center pt-16 snap-start shrink-0 pointer-events-auto">
            <div id="canvas-container"></div>
            <div class="relative z-10 text-center pointer-events-none px-6">
                <p class="text-xs font-bold tracking-[0.4em] uppercase mb-6 opacity-60 reveal-on-scroll">Welcome to</p>
                <h1 class="text-6xl md:text-8xl font-serif mb-6 tracking-tighter reveal-on-scroll" style="transition-delay: 200ms;">东 华 市</h1>
                <p class="max-w-md mx-auto text-sm md:text-base font-light leading-relaxed opacity-70 mb-12 reveal-on-scroll" style="transition-delay: 400ms;">
                    探索未知的边界，连结破碎的规则。<br>这里……是梦开始的地方。<br><br><br>
                </p>
            </div>
            <div class="absolute bottom-4 z-10 flex flex-col items-center gap-2 opacity-60 cursor-pointer pointer-events-auto hover:opacity-100 transition-opacity reveal-on-scroll" style="transition-delay: 600ms;" onclick="customSmoothScroll('gallery-section')">
                <span class="text-[10px] tracking-[0.2em] uppercase">Click to Explore</span>
                <i data-lucide="chevron-down" class="w-6 h-6 scroll-indicator"></i>
            </div>
        </section>

        <!-- 第二屏：Gallery (旋转相册) -->
        <section id="gallery-section" class="bg-white transition-colors duration-1000 py-20 snap-start min-h-screen flex flex-col justify-center shrink-0 overflow-hidden">
            <header class="relative px-6 text-center mb-8 reveal-on-scroll">
                <p class="text-xs font-bold tracking-[0.3em] text-gray-400 uppercase mb-4">The Collection</p>
                <h2 class="text-4xl md:text-6xl font-serif mb-4 text-gray-900">设定</h2>
                <div class="w-12 h-0.5 bg-gray-900 mx-auto"></div>
            </header>

            <!-- 筛选按钮 -->
            <div class="flex justify-center gap-4 mb-8 px-6 flex-wrap reveal-on-scroll" id="filter-container" style="transition-delay: 200ms;">
                <button onclick="filterGallery('character')" class="filter-btn active px-5 py-2 border border-black bg-black text-white text-xs uppercase tracking-wider transition hover:opacity-80" data-type="character">人物</button>
                <button onclick="filterGallery('organization')" class="filter-btn px-5 py-2 border border-gray-200 text-gray-500 text-xs uppercase tracking-wider hover:border-gray-400 hover:text-black transition bg-transparent" data-type="organization">组织</button>
                <button onclick="filterGallery('item')" class="filter-btn px-5 py-2 border border-gray-200 text-gray-500 text-xs uppercase tracking-wider hover:border-gray-400 hover:text-black transition bg-transparent" data-type="item">污染物</button>
            </div>

            <!-- 旋转相册容器 -->
            <div class="relative w-full max-w-6xl mx-auto h-[500px] md:h-[600px] flex items-center justify-center reveal-on-scroll" style="transition-delay: 400ms;">
                
                <!-- 左箭头 -->
                <button onclick="rotateCarousel('prev')" class="absolute left-4 md:left-12 z-40 p-4 rounded-full bg-white/10 hover:bg-black/10 backdrop-blur-sm text-gray-800 transition-all hover:scale-110 focus:outline-none border border-gray-200/50 shadow-lg">
                    <i data-lucide="chevron-left" class="w-6 h-6 md:w-8 md:h-8"></i>
                </button>

                <!-- 图片轨道 (3D空间) -->
                <div id="carousel-track" class="relative w-full h-full">
                    <!-- JS 动态生成并持久化的卡片元素 -->
                </div>

                <!-- 右箭头 -->
                <button onclick="rotateCarousel('next')" class="absolute right-4 md:right-12 z-40 p-4 rounded-full bg-white/10 hover:bg-black/10 backdrop-blur-sm text-gray-800 transition-all hover:scale-110 focus:outline-none border border-gray-200/50 shadow-lg">
                    <i data-lucide="chevron-right" class="w-6 h-6 md:w-8 md:h-8"></i>
                </button>

                <!-- 底部指示器 -->
                <div class="absolute bottom-4 left-0 right-0 text-center z-40 text-xs tracking-[0.3em] uppercase text-gray-400 pointer-events-none">
                    <span id="current-counter">1</span> / <span id="total-counter">10</span>
                </div>
            </div>
        </section>

        <!-- 第三屏：Stories -->
        <section id="stories-section" class="bg-[#f4f4f4] transition-colors duration-1000 py-20 border-t border-gray-200 snap-start min-h-screen flex flex-col justify-center shrink-0">
            <header class="relative px-6 text-center mb-16 reveal-on-scroll">
                <p class="text-xs font-bold tracking-[0.3em] text-gray-400 uppercase mb-4">Stories</p>
                <h2 class="text-4xl md:text-6xl font-serif mb-4 text-gray-900">剧情</h2>
                <div class="w-12 h-0.5 bg-gray-900 mx-auto"></div>
            </header>

            <div class="max-w-5xl mx-auto px-6 w-full">
                <div id="stories-list" class="flex flex-col gap-12">
                    <!-- JS动态渲染 -->
                </div>
            </div>
        </section>

        <!-- 底部 -->
        <footer class="border-t border-gray-200 py-12 text-center bg-[#f9f9f9] transition-colors duration-1000 snap-start shrink-0">
            <div class="text-2xl font-serif mb-4 text-[#333]">MY COLLECTION</div>
            <p class="text-gray-400 text-xs tracking-wider">© 2023 OC GALLERY. DESIGNED WITH MINIMALISM.</p>
        </footer>
    </main>

    <!-- 详情模态框 (SSIS 报告模态框也放在这里) -->
    <!-- 详情模态框 -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden opacity-0 flex items-center justify-center transition-opacity duration-500 p-4">
        <div class="absolute inset-0" onclick="closeModal()"></div>
        <div id="modal-content" class="relative w-full max-w-5xl h-[85vh] bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col md:flex-row transform scale-95 opacity-0 transition-all duration-500"> 
            <button onclick="closeModal()" class="absolute top-4 right-4 z-20 bg-white/20 backdrop-blur-md p-2 rounded-full hover:bg-white hover:text-black text-white transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div id="modal-body" class="flex flex-col md:flex-row w-full h-full">
                <!-- 内容由JS填充 -->
            </div>
        </div>
    </div>
    
    <!-- ============================================== -->
    <!-- === SSIS 后台管理系统 - 全屏模态框容器 (新增) === -->
    <!-- ============================================== -->
    <div id="ssis-modal-overlay" class="fixed inset-0 bg-white hidden opacity-0 transition-opacity duration-300 ssis-body flex flex-col">
        
        <!-- 头部：教育局信息监管平台 -->
        <header class="w-full h-16 bg-white border-b border-gray-200 z-50 shadow-sm shrink-0">
            <div class="h-full flex items-center justify-between px-6">
                <div class="text-xl font-bold tracking-wider text-primary-blue flex items-center gap-2">
                    <i data-lucide="shield-check" class="w-6 h-6"></i>
                    东华市教育局信息监管平台
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <span class="text-gray-500 hidden sm:inline">管理员: Loriva</span>
                    <!-- 新增：关闭按钮 -->
                    <button onclick="closeSSIS()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 transition-colors flex items-center gap-1">
                        <span class="text-xs uppercase font-bold hidden sm:inline">Exit Backend</span>
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主容器：侧边栏 + 内容区 -->
        <div class="flex flex-1 w-full h-[calc(100%-4rem)]"> 
            
            <!-- 侧边栏 (Sidebar) -->
            <aside class="w-64 bg-white border-r border-gray-200 p-4 shrink-0 overflow-y-auto h-full hidden md:block">
                <h3 class="text-xs uppercase tracking-widest font-bold text-gray-500 mb-6 border-b border-gray-100 pb-2">数据过滤</h3>
                <div class="space-y-3">
                    <button onclick="filterStudents('all')" class="sidebar-link active flex items-center gap-3 w-full p-3 rounded-lg text-sm font-semibold bg-primary-blue text-white transition-colors hover:bg-indigo-700">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        所有学生档案
                    </button>
                    <button onclick="filterStudents('donghua')" class="sidebar-link flex items-center gap-3 w-full p-3 rounded-lg text-sm font-medium text-gray-600 transition-colors hover:bg-gray-100 hover:text-gray-800">
                        <i data-lucide="school" class="w-5 h-5"></i>
                        东华高级中学
                    </button>
                    <button onclick="filterStudents('jiangnan')" class="sidebar-link flex items-center gap-3 w-full p-3 rounded-lg text-sm font-medium text-gray-600 transition-colors hover:bg-gray-100 hover:text-gray-800">
                        <i data-lucide="university" class="w-5 h-5"></i>
                        江南大学附属高等学院
                    </button>
                    <button onclick="filterStudents('asano')" class="sidebar-link flex items-center gap-3 w-full p-3 rounded-lg text-sm font-medium text-gray-600 transition-colors hover:bg-gray-100 hover:text-gray-800">
                        <i data-lucide="layout-list" class="w-5 h-5"></i>
                        市立浅野寺国际高等学院
                    </button>
                </div>
                
                <h3 class="text-xs uppercase tracking-widest font-bold text-gray-500 mt-8 mb-4 border-b border-gray-100 pb-2">系统状态</h3>
                <div id="system-status-container" class="space-y-3">
                    <div class="flex items-center text-sm text-green-600 bg-green-50 p-3 rounded-lg">
                        <i data-lucide="monitor-check" class="w-4 h-4 mr-2"></i>
                        数据流：稳定运行 (3ms)
                    </div>
                    <div class="flex items-center text-sm text-red-600 bg-red-50 p-3 rounded-lg">
                        <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>
                        数据流：数据异常！
                    </div>
                </div>
            </aside>
            
            <!-- 主内容区：列表 + 详情 -->
            <div class="flex flex-1 h-full overflow-hidden">
                <!-- 左侧：学生列表 (Student List) -->
                <section class="w-full md:w-1/3 border-r border-gray-200 bg-white p-6 backend-scroll overflow-y-auto shrink-0">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">学生列表 (共 <span id="student-count">4</span> 名)</h2>
                    <div id="student-list" class="space-y-4">
                        <!-- Students cards generated here by JS -->
                    </div>
                </section>

                <!-- 右侧：详细信息面板 (Detail Panel) -->
                <section class="w-2/3 bg-bg-light p-8 backend-scroll overflow-y-auto hidden md:block">
                    
                    <div id="detail-panel-header" class="mb-8 p-6 bg-white rounded-lg shadow-md border-t-4 border-primary-blue hidden">
                        <h3 id="detail-name" class="text-3xl font-bold"></h3>
                        <p id="detail-role" class="text-sm text-gray-500 mt-1"></p> 
                        <div id="detail-tags" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>

                    <div id="detail-tabs" class="flex border-b border-gray-200 mb-6 hidden">
                        <button data-tab="card" onclick="switchDetailTab('card')" class="tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-primary-blue text-primary-blue transition-colors">学生证预览</button>
                        <button data-tab="academic" onclick="switchDetailTab('academic')" class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 transition-colors hover:text-gray-800 hover:border-gray-300 border-b-2 border-transparent">学籍档案</button>
                        <button data-tab="health" onclick="switchDetailTab('health')" class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 transition-colors hover:text-gray-800 hover:border-gray-300 border-b-2 border-transparent">健康档案</button>
                    </div>
                    
                    <div id="detail-content" class="min-h-[60vh] flex items-center justify-center text-gray-400 text-lg">
                        请从左侧选择一名学生查看档案。
                    </div>

                </section>
            </div>
        </div>
    </div>


    <!-- SSIS 报告弹窗模态框 -->
    <div id="report-modal-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden opacity-0 flex items-center justify-center p-4" onclick="closeReportModal()">
        <div id="report-modal-content" class="bg-white w-full max-w-3xl h-[85vh] rounded-xl shadow-2xl flex flex-col transform scale-95 opacity-100" onclick="event.stopPropagation()">
            <!-- 头部 -->
            <div class="p-4 md:p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-xl font-bold text-primary-blue flex items-center gap-2">
                    <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                    <span id="report-title">体检报告</span>
                </h3>
                <button onclick="closeReportModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- 报告主体内容 -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 text-sm">
                <div class="space-y-6 report-body">
                    <div class="border-b pb-4">
                        <p class="text-sm text-gray-600">学生姓名: <span id="report-student-name" class="font-bold text-gray-800"></span></p>
                        <p class="text-xs text-gray-400">报告日期: 2025-09-01</p>
                    </div>

                    <!-- 摘要 -->
                    <div>
                        <h5 class="text-base font-semibold text-primary-blue mb-2">摘要总结</h5>
                        <p id="report-summary" class="bg-blue-50 p-3 rounded-lg text-gray-700 italic border border-blue-200"></p>
                    </div>

                    <!-- 详细发现 (修改为左右两栏布局) -->
                    <div>
                        <h5 class="text-base font-semibold text-primary-blue mb-4">详细发现与生理指标</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- 左侧: 图像占位符 -->
                            <div>
                                <h6 class="text-sm font-medium text-gray-600 mb-2 flex items-center gap-1">
                                    <i data-lucide="image" class="w-4 h-4 text-gray-500"></i>诊断图像
                                </h6>
                                <div class="w-full aspect-square bg-gray-100 rounded-lg border border-gray-300 flex items-center justify-center overflow-hidden">
                                    <img id="report-diagnosis-image" src="" alt="诊断图像" class="w-full h-full object-cover">
                                </div>
                            </div>

                            <!-- 右侧: 数据列表 -->
                            <div>
                                <h6 class="text-sm font-medium text-gray-600 mb-2 flex items-center gap-1">
                                    <i data-lucide="list-checks" class="w-4 h-4 text-gray-500"></i>发现列表
                                </h6>
                                <ul id="report-findings" class="list-none space-y-2 border border-gray-200 rounded-lg p-3 bg-white shadow-sm">
                                    <!-- JS填充 -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 结论 -->
                    <div>
                        <h5 class="text-base font-semibold text-primary-blue mb-2">结论建议</h5>
                        <p id="report-conclusion" class="p-3 border-l-4 border-green-500 bg-green-50 text-gray-700"></p>
                    </div>

                    <!-- 底部盖章模拟 -->
                    <div class="pt-6 text-right">
                        <p class="text-xs text-gray-500">报告生成单位：东华市校医院/安全部门</p>
                        <p class="text-xs text-gray-500">报告编号：DH-2025-1121-RPT</p>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <!-- 阅读器 (隐藏结构) -->
    <div id="reading-mode" class="fixed inset-0 z-[100] bg-[#F6F4EC] hidden flex flex-col transform translate-y-full transition-colors duration-300">
        <div class="h-14 px-4 flex items-center justify-between border-b border-[#e6e4dc] bg-[#F6F4EC]/95 backdrop-blur sticky top-0 z-10">
            <div class="flex items-center gap-4">
                <button onclick="toggleTOC()" class="p-2 hover:bg-[#e6e4dc] rounded transition-colors text-gray-600 flex items-center gap-2">
                    <i data-lucide="list" class="w-5 h-5"></i>
                    <span class="hidden sm:inline text-xs tracking-widest uppercase font-bold">Directory</span>
                </button>
                <span id="reader-book-title" class="text-sm font-serif text-gray-500 hidden md:block">Story Title</span>
            </div>
            <button onclick="closeReader()" class="p-2 hover:bg-[#e6e4dc] rounded transition-colors text-gray-600 flex items-center gap-2">
                <span class="hidden sm:inline text-xs tracking-widest uppercase font-bold">Exit Reader</span>
                    <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="reader-scroll-container" class="flex-1 overflow-y-auto relative no-scrollbar scroll-smooth">
            <div class="max-w-3xl mx-auto px-6 py-12 md:py-20">
                <h2 id="reader-chapter-title" class="text-3xl md:text-4xl font-serif font-bold text-gray-800 mb-12 text-center">Chapter Title</h2>
                <div id="reader-content" class="font-reading text-lg md:text-xl leading-loose text-gray-800 text-justify space-y-6"></div>
                <div class="mt-24 flex justify-between items-center pt-8 border-t border-[#e0ded6]">
                    <button id="btn-prev-chapter" onclick="prevChapter()" class="text-[#888] hover:text-black flex items-center gap-2 transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i> 上一章
                    </button>
                    <button id="btn-next-chapter" onclick="nextChapter()" class="text-[#888] hover:text-black flex items-center gap-2 transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
                        下一章 <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="toc-sidebar" class="absolute top-0 left-0 bottom-0 w-64 bg-white shadow-xl transform -translate-x-full z-20 overflow-y-auto border-r border-gray-100">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <span class="text-sm tracking-widest font-bold uppercase text-[#333]">目录</span>
                <button onclick="toggleTOC()"><i data-lucide="x" class="w-4 h-4 text-gray-400 hover:text-black"></i></button>
            </div>
            <div id="toc-list" class="py-2"></div>
        </div>
        <div id="toc-overlay" onclick="toggleTOC()" class="absolute inset-0 bg-black/20 backdrop-blur-[1px] z-10 hidden opacity-0 transition-opacity"></div>
    </div>
    
    <!-- 删除了版权页 HTML 结构 -->
    <!-- 删除了复制成功的提示 (Toast) HTML 结构 -->

    <script>
        // === 基础逻辑 (Three.js/音乐/滚动/通用数据) ===
        
        // Three.js 变量
        let scene, camera, renderer, globe;
        const worldSection = document.getElementById('world-section');

        function initThree() {
            const container = document.getElementById('canvas-container');
            // 设置场景、相机、渲染器
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 12;
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            // 创建点阵球体 (Light mode color: 0x333333)
            const geometry = new THREE.IcosahedronGeometry(5, 4);
            const material = new THREE.PointsMaterial({ color: 0x333333, size: 0.08, sizeAttenuation: true });
            globe = new THREE.Points(geometry, material);
            scene.add(globe);

            // 创建线框环 (Light mode color: 0xcccccc)
            const ringGeo = new THREE.IcosahedronGeometry(6, 1);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0xcccccc, wireframe: true, transparent: true, opacity: 0.2 });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            scene.add(ring);

            // 设置雾效 (Light mode fog: 0xe0e0e0)
            scene.fog = new THREE.FogExp2(0xe0e0e0, 0.05); 

            function animate() {
                requestAnimationFrame(animate);
                // 自动旋转
                globe.rotation.y += 0.002; 
                globe.rotation.x += 0.0005;
                ring.rotation.y -= 0.002; 
                ring.rotation.z += 0.001;
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
            
            // 鼠标移动监听器 (用于实现视差旋转)
            worldSection.addEventListener('mousemove', (event) => {
                const rect = worldSection.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                const normalizedX = (x / rect.width) * 2 - 1;
                const normalizedY = (y / rect.height) * 2 - 1; 

                const targetRotationY = normalizedX * 0.5;
                const targetRotationX = normalizedY * 0.5;

                // 使用缓动函数平滑旋转场景
                scene.rotation.y += 0.05 * (targetRotationY - scene.rotation.y);
                scene.rotation.x += 0.05 * (targetRotationX - scene.rotation.x);
            });
        }
        
        initThree(); // 初始化 Three.js 场景

        // Music 音乐控制
        const bgm = document.getElementById('bgm');
        bgm.volume = 0.4;
        function toggleMusic() {
            const btn = document.getElementById('music-toggle');
            const icon = document.getElementById('icon-music');
            const wave = document.getElementById('music-wave');
            if (bgm.paused) {
                bgm.play();
                btn.classList.add('text-black');
                icon.classList.add('music-playing');
                wave.classList.remove('opacity-0');
                wave.classList.add('animate-ping');
            } else {
                bgm.pause();
                btn.classList.remove('text-black');
                icon.classList.remove('music-playing');
                wave.classList.add('opacity-0');
                wave.classList.remove('animate-ping');
            }
        }

        // 滚动功能
        function customSmoothScroll(targetId) {
            const el = document.getElementById(targetId);
            const container = document.getElementById('scroll-container');
            if(el && container) {
                 container.scrollTo({ top: el.offsetTop, behavior: 'smooth' });
                 if(bgm.paused) toggleMusic(); // 滚动时尝试播放播放音乐
            }
        }
        
        // 滚动显示动画
        function initScrollReveal() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(e => { 
                    if (e.isIntersecting) {
                        e.target.classList.add('visible');
                        // 停止观察，避免重复触发
                        observer.unobserve(e.target); 
                    }
                });
            }, { root: document.getElementById('scroll-container'), threshold: 0.1 }); // 阈值调整为 0.1
            document.querySelectorAll('.reveal-on-scroll').forEach(el => observer.observe(el));
        }
        document.addEventListener('DOMContentLoaded', initScrollReveal);

        // === Data (my_universe 数据) ===
        const DEFAULT_AVATAR = "https://placehold.co/400x600/e0e0e0/999999?text=UNKNOWN";
        const DEFAULT_LANDSCAPE = "https://placehold.co/600x800/e5e5e5/cccccc?text=UNKNOWN";
        const DEFAULT_ORG = "https://placehold.co/600x800/d4d4d4/888888?text=UNKNOWN";

        const collection = [
            { id: 1, category: 'character', name: "我", englishName: "Writer", role: "执笔人", tags: ["东华人"], desc: "私立东华高级中学高二在读，高二六班班长。", details: { "Age": "18", "MBTI": "ENFP" }, image: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBU_BpH-sz5oA4tuKBtGAzKRcviHoDPQACTgtrG0Q3AAFFZM8GWRPXjKwBAAMCAAN5AAM2BA.jpg", quote: "对于自己，你一定很熟悉……" },
            { id: 2, category: 'character', name: "宋佩姿", englishName: "茄茄", role: "钢铁女战士", tags: ["清冷系", "模范学生"], desc: "私立东华高级中学高二在读，英语课代表，校学生会仪式部部员，校舞蹈社社员。", details: { "年龄": "17","生日": "0702", "MBTI": "INFJ", "爱好": "读书、绘画" }, image: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBU_RpH_R2m6ow7OylL-iFkslrYNV5IAACVAtrG0Q3AAFFLiHOpswm2B8BAAMCAAN5AAM2BA.png", quote: "我喜欢你，因为你就是你。" },
            { id: 3, category: 'character', name: "薛锦烨", englishName: "Melody", role: "剧本杀出片大王", tags: ["活力满满", "才艺担当"], desc: "私立东华高级中学高二在读，文艺委员，校学生会仪式部部长，校舞蹈社社长。", details: { "年龄": "17","生日": "0117", "MBTI": "ENFP", "爱好": "跳舞、唱歌" }, image: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBU_JpH_GWI3uNz5n4ZK1qefAeaKgjXwACUgtrG0Q3AAFFL16SF2pqPMMBAAMCAAN5AAM2BA.png", quote: "请叫我剧本杀出片大王！" },
            { id: 4, category: 'character', name: "李婧瑶", englishName: "Rita", role: "奶茶净杯使者", tags: ["东华人"], desc: "江南大学附属高等学院高二在读，校学生会外联部部长。", details: { "年龄": "18", "MBTI": "INTJ" }, image: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBVAJpIIsECeEqlGKc86g6UhJjPlblZgACGgtrG0Q3CEV951uJP35AugEAAwIAA3kAAzYE.png", quote: "我会跑遍地中海收集柑橘类水果。" },
            { id: 5, category: 'character', name: "张琰清", englishName: "阿珞", role: "薄荷巧克力", tags: ["东华人"], desc: "市立浅野寺国际高等学院高二在读。", details: { "年龄": "18", "MBTI": "ENTJ" }, image: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBU-9pH-htGBlwahB_WjFXdtHGH3VTeAACTQtrG0Q3AAFF9JRxk_lJ__ABAAMCAAN5AAM2BA.jpg", quote: "Every flower blooms upon your arrival." },

            { id: 101, category: 'item', name: "私立东华高级中学二〇二三版校规", englishName: "School Regulations of Private Donghua Senior High School 2023 ver.", role: "一切的开端", tags: ["重度污染物", "常识扭曲", "群体"], desc: "凭空出现的校规，对于学生的着装方面做出了详细的要求。", details: { "Members": "Unknown" }, image: DEFAULT_ORG, quote: "" },
            { id: 102, category: 'item', name: "白水晶手串", englishName: "White crystal bracelet", role: "好运常在", tags: ["轻度污染物", "幸运", "个人"], desc: "我送给宋佩姿的生日礼物，可以为她带来源源不断的好运", details: { "Stock": "Unknown" }, image: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBU-hpH9Z5ecCNEcgOYuMlwSpxvlBsuQACPgtrG0Q3AAFFUbflgSMynt0BAAMCAAN3AAM2BA.png", quote: "银光闪烁，奥妙其中，好运连连，福泽绵绵。" },
            { id: 103, category: 'item', name: "学生身份卡", englishName: "ID Card", role: "身份不明", tags: ["中度污染物", "常识扭曲","群体"], desc: "市教育局建立的全市统一学生档案，每一名学生都会配发一张数字信息卡以关联数据库。", details: { "Type": "Unknown" }, image: DEFAULT_ORG, quote: "" },
            { id: 301, category: 'organization', name: "私立东华高级中学", englishName: "", role: "私立十二年一贯制·共校", tags: ["超重度规则污染区"], desc: "东华市顶级私立高中之一，坐落于市区东北角，为半封闭制校，入学要求严苛，同时考虑学习成绩和外貌条件，男女比例为六比四，重本率为85%。", details: { "危险等级": "5" }, image: DEFAULT_LANDSCAPE, quote: "东华市最优秀的高中之一。" },
            { id: 302, category: 'organization', name: "江南大学附属高等学院外联部", englishName: "", role: "政府直辖市重点·共校", tags: ["中度规则污染区"], desc: "东华市顶级公立高中之一，坐落于市区中心。", details: { "危险等级": "3" }, image: DEFAULT_LANDSCAPE, quote: "听说这里不让谈恋爱……？。" },
            { id: 303, category: 'organization', name: "市立浅野寺国际高等学院", englishName: "", role: "政府直辖市重点·女子校", tags: ["中度规则污染区", "权力真空"], desc: "东华市顶级公立高中之一，坐落于市区中心，为女校，常年实行封闭式管理。", details: { "危险等级": "2" }, image: DEFAULT_LANDSCAPE, quote: "浅野寺，你是我唯一的希望。" },
            
            // 详细故事内容
            { id: 201, category: 'story', name: "序章：破碎的皇冠", englishName: "Prologue", role: "Chapter 1", tags: ["War"], desc: "王都陷落...", details: { "Words": "5k" }, image: DEFAULT_LANDSCAPE, quote: "重铸荣耀。", content: `
                <p>王都伊甸的陷落，不是在一瞬间发生的，而是在漫长而阴冷的黄昏中，慢慢熄灭的最后一道光芒。</p>
                <p>当警报声撕裂天际时，城墙上的守卫已经疲惫不堪，他们的铠甲被浓郁的黑雾腐蚀，失去了昔日的光泽。黑雾，这种来自“污秽边界”的污染物，像潮水一样涌入城邦，扭曲着一切常识和物理法则。</p>
                <p>“我们必须撤退！陛下！”一个年轻的骑士冲进大殿，他的声音带着绝望的颤抖。大殿中央，象征着荣耀的黄金王冠已经破碎，散落在冰冷的石砖上，反射着微弱的光。那光芒，就像是这个世界最后的希望。</p>
                <p>老国王平静地坐在王座上，他看着门外的黑雾，眼神里没有恐惧，只有一种深深的疲倦。他知道，这不是一场可以靠剑与魔法赢得的战斗。这是规则与常识的崩塌。</p>
                <p>他轻轻挥手：“去吧，带着你能带走的一切。记住，**重铸荣耀**，必须从寻找新的规则开始。”</p>
            ` },
            { id: 202, category: 'story', name: "幕间：雨中蓝调", englishName: "Interlude", role: "Side Story", tags: ["Jazz"], desc: "废弃酒吧...", details: { "Words": "2k" }, image: DEFAULT_LANDSCAPE, quote: "故障才是自由。", content: `
                <p>雨夜。霓虹灯的招牌在废弃的“蓝调角落”酒吧外闪烁，发出微弱的滋滋声，仿佛是城市在低声呻吟。</p>
                <p>宋佩姿坐在吧台前，用指尖轻轻敲打着高脚杯的边缘，发出清脆的音符。她穿着一件不合时宜的白色连衣裙，在这黑暗的环境中显得过于干净。</p>
                <p>调酒师，一个脸上带着机械义体纹路的男人，递给她一杯无酒精的薄荷水。“东华市的雨，总是这么腻人。”他沙哑地说道。</p>
                <p>“不是雨腻人，是规则腻人。”宋佩姿轻声回答，眼神穿过窗外模糊的雨点，看向远处高耸的东华高级中学。那座建筑在雨夜中像一头沉睡的巨兽，充满着秩序和压力。</p>
                <p>突然，空气中传来一阵不和谐的电子音，那是她口袋里的学生身份卡发出的警告。她皱了皱眉，那是**常识扭曲**的信号。</p>
                <p>“看来，又有东西想要打破平静了。”她站起身，白色裙摆在微弱的灯光下摇曳。调酒师没有回头，只是低声说：“祝你好运，战士。”</p>
            ` }
        ];

        // === 核心：动画增强版旋转相册逻辑 (保持不变) ===
        let galleryItems = [];
        let activeIndex = 0;
        let currentCategory = 'character';
        const carouselTrack = document.getElementById('carousel-track');
        const filterBtns = document.querySelectorAll('.filter-btn');
        let cardElements = [];

        function filterGallery(type) {
            currentCategory = type;
            activeIndex = 0; 
            filterBtns.forEach(btn => {
                const isActive = btn.dataset.type === type;
                if (isActive) {
                    btn.className = "filter-btn active px-5 py-2 border border-black bg-black text-white text-xs uppercase tracking-wider transition hover:opacity-80";
                } else {
                    btn.className = "filter-btn px-5 py-2 border border-gray-200 text-gray-500 text-xs uppercase tracking-wider hover:border-gray-400 hover:text-black transition bg-transparent";
                }
            });
            initCarousel();
        }

        function initCarousel() {
            galleryItems = collection.filter(item => item.category === currentCategory);
            
            document.getElementById('total-counter').innerText = galleryItems.length;
            
            // 1. 清空轨道
            carouselTrack.innerHTML = '';
            cardElements = [];

            if (galleryItems.length === 0) {
                carouselTrack.innerHTML = `<div class="text-gray-400 font-serif italic text-center w-full absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">暂无内容</div>`;
                return;
            }

            // 2. 一次性生成所有卡片 DOM
            galleryItems.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `carousel-item w-[260px] md:w-[320px] aspect-[3/4] bg-gray-200 rounded-xl overflow-hidden shadow-2xl`;
                card.innerHTML = `
                    <img src="${item.image}" class="w-full h-full object-cover" alt="${item.name}" onerror="this.onerror=null; this.src='https://placehold.co/400x600/1e293b/ffffff?text=Image+Missing';">
                    <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent text-white text-center">
                        <p class="text-xs font-bold tracking-widest uppercase mb-1 opacity-80">${item.role}</p>
                        <h3 class="text-xl font-serif">${item.name}</h3>
                    </div>
                `;
                card.dataset.index = index;
                card.onclick = () => handleCardClick(index, item.id);
                
                carouselTrack.appendChild(card);
                cardElements.push(card);
            });

            // 3. 初次渲染状态
            updateCarouselState();
        }

        function handleCardClick(index, itemId) {
            const len = galleryItems.length;
            let diff = (index - activeIndex + len) % len;
            
            if (diff === 0) {
                openModal(itemId);
            } else if (diff === 1) {
                rotateCarousel('next');
            } else if (diff === len - 1) {
                rotateCarousel('prev');
            } else {
                if (diff < len / 2) {
                    for (let i = 0; i < diff; i++) rotateCarousel('next');
                } else {
                    for (let i = 0; i < len - diff; i++) rotateCarousel('prev');
                }
            }
        }

        function updateCarouselState() {
            if (galleryItems.length === 0) return;
            document.getElementById('current-counter').innerText = activeIndex + 1;

            const len = galleryItems.length;
            
            cardElements.forEach((card, index) => {
                card.classList.remove('carousel-center', 'carousel-left', 'carousel-right', 'carousel-hidden');
                let diff = (index - activeIndex + len) % len;

                if (diff === 0) {
                    card.classList.add('carousel-center');
                } else if (diff === len - 1) { 
                    card.classList.add('carousel-left');
                } else if (diff === 1) { 
                    card.classList.add('carousel-right');
                } else {
                    card.classList.add('carousel-hidden');
                }
            });
        }

        function rotateCarousel(direction) {
            const len = galleryItems.length;
            if (len <= 1) return;

            if (direction === 'next') {
                activeIndex = (activeIndex + 1) % len;
            } else {
                activeIndex = (activeIndex - 1 + len) % len;
            }
            updateCarouselState();
        }

        // --- 导航至 SSIS 后台的专用函数 ---
        function navigateToSSIS(itemName) {
            closeModal(); // 先关闭模态框
            openSSIS();   // 打开 SSIS 模态框
            
            // 假设“学生身份卡”对应的是宋佩姿 (ID 2)
            if (itemName === '学生身份卡') {
                // 确保 SSIS 初始化并选择目标档案
                selectStudent(2); 
                switchDetailTab('health'); 
            } else {
                // 对于其他污染物，只打开 SSIS 
                renderStudentList('all');
                if (ALL_STUDENTS.length > 0) {
                    selectStudent(ALL_STUDENTS[0].id);
                }
            }
        }
        
        function openSSIS() {
            const ssisModal = document.getElementById('ssis-modal-overlay');
            ssisModal.classList.remove('hidden');
            setTimeout(() => ssisModal.classList.remove('opacity-0'), 10);
            document.getElementById('scroll-container').style.overflow = 'hidden'; 
            document.body.style.overflow = 'hidden'; 
        }

        function closeSSIS() {
            const ssisModal = document.getElementById('ssis-modal-overlay');
            ssisModal.classList.add('opacity-0');
            setTimeout(() => {
                ssisModal.classList.add('hidden');
                document.getElementById('scroll-container').style.overflow = '';
                document.body.style.overflow = '';
            }, 500);
        }
        // ------------------------------------

        // === 故事列表/模态框/阅读器/版权页/复制逻辑 (保持不变) ===
        
        function renderStories() {
            const storiesList = document.getElementById('stories-list');
            const storyItems = collection.filter(item => item.category === 'story');
            storiesList.innerHTML = storyItems.map((item, index) => `
                <div class="flex flex-col md:flex-row gap-8 items-start group bg-white p-6 shadow-sm hover:shadow-md transition-shadow duration-300 border border-gray-100 reveal-on-scroll" style="transition-delay: ${index * 200}ms">
                    <div class="w-full md:w-64 aspect-[3/4] md:aspect-[4/3] overflow-hidden shrink-0 cursor-pointer" onclick="openReader(${item.id})">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.onerror=null; this.src='https://placehold.co/600x800/1e293b/ffffff?text=Image+Missing';">
                    </div>
                    <div class="flex-1 flex flex-col justify-between h-full">
                        <div>
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-xs font-bold tracking-widest text-gray-400 uppercase border border-gray-200 px-2 py-1 rounded">${item.tags[0]}</span>
                                <span class="text-xs text-gray-400 uppercase tracking-wider">${item.role}</span>
                            </div>
                            <h3 class="text-2xl font-serif text-gray-900 mb-2 cursor-pointer hover:text-gray-600 transition-colors" onclick="openReader(${item.id})">${item.name}</h3>
                            <p class="text-xs text-gray-400 uppercase tracking-widest mb-6">${item.englishName}</p>
                            <p class="text-gray-500 font-light leading-relaxed mb-6 line-clamp-3">${item.desc}</p>
                        </div>
                        <div class="flex items-center justify-between mt-auto pt-6 border-t border-gray-100">
                            <div class="flex gap-4 text-xs text-gray-400 uppercase tracking-widest">
                                <span>${item.details.Words} Words</span>
                            </div>
                            <button onclick="openReader(${item.id})" class="text-xs font-bold uppercase tracking-widest border-b border-black pb-1 hover:opacity-60 transition-opacity">Read Chapter</button>
                        </div>
                    </div>
                </div>
            `).join('');
            initScrollReveal();
        }

        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');
        const modalBody = document.getElementById('modal-body');
        let currentDetailId = null;

        function openModal(id) {
            const item = collection.find(c => c.id === id);
            if (!item) return;
            currentDetailId = id;
            renderModalContent(item);
            modalOverlay.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.getElementById('scroll-container').style.overflow = 'hidden';
            document.addEventListener('keydown', handleModalKeydown);
        }

        function closeModal() {
            document.removeEventListener('keydown', handleModalKeydown);
            modalOverlay.classList.add('opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            document.getElementById('scroll-container').style.overflow = '';
            setTimeout(() => modalOverlay.classList.add('hidden'), 300);
        }

        function handleModalKeydown(e) { if (e.key === 'Escape') closeModal(); }

        function renderModalContent(item) {
            const detailsHtml = Object.entries(item.details).map(([key, value]) => 
                `<div><span class="block text-xs text-gray-400 uppercase tracking-widest mb-1">${key}</span><span class="font-serif text-lg text-gray-800">${value}</span></div>`
            ).join('');
            
            // --- 新增逻辑：学生信息管理后台链接 (针对污染物类别) ---
            let backendLinkHtml = '';
            if (item.category === 'item') {
                 // 注意：这里调用了 navigateToSSIS 函数
                 backendLinkHtml = `
                    <div class="mt-8 pt-8 border-t border-gray-100">
                        <button onclick="navigateToSSIS('${item.name}')" class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 border border-red-500 text-red-600 bg-red-50 hover:bg-red-100 transition-colors rounded-lg text-sm font-bold uppercase tracking-widest shadow-md hover:shadow-lg">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                            <span>前往学生信息管理后台查看详情</span>
                        </button>
                    </div>
                 `;
            }
            // --------------------------------------------------------

            modalBody.innerHTML = `
                <div id="modal-left-image" class="relative shrink-0 bg-gray-100 w-full aspect-[3/4] md:w-auto md:h-full md:aspect-[3/4]">
                    <img src="${item.image}" class="w-full h-full object-cover" alt="${item.name}" onerror="this.onerror=null; this.src='https://placehold.co/400x600/1e293b/ffffff?text=Image+Missing';">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent md:hidden"></div>
                    <div class="absolute bottom-4 left-6 text-white md:hidden"><h2 class="text-3xl font-serif">${item.name}</h2></div>
                </div>
                <div id="modal-right-text" class="flex-1 p-8 md:p-12 overflow-y-auto">
                    <div class="flex flex-col h-full">
                        <div class="mb-8 hidden md:block">
                             <p class="text-xs tracking-[0.2em] opacity-50 mb-2 uppercase text-gray-500">${item.englishName}</p>
                             <h2 class="text-4xl md:text-5xl font-serif text-gray-900">${item.name}</h2>
                        </div>
                        <div class="mb-8 text-center md:text-left relative">
                            <span class="text-6xl font-serif text-gray-100 absolute -top-4 -left-4 z-0">“</span>
                            <p class="text-xl font-serif italic text-gray-800 relative z-10 pl-6 border-l-2 border-gray-900">${item.quote}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-8 justify-center md:justify-start">
                            ${item.tags.map(tag => `<span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs tracking-wider uppercase rounded-sm">${tag}</span>`).join('')}
                        </div>
                        <div class="prose prose-sm max-w-none text-gray-500 leading-relaxed mb-8 text-justify">${item.desc}</div>
                        <div class="grid grid-cols-2 gap-y-8 border-t border-gray-100 pt-8 mt-auto">${detailsHtml}</div>
                        ${backendLinkHtml} <!-- 注入新增的按钮 -->
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // 阅读器逻辑 (省略)
        const readingMode = document.getElementById('reading-mode');
        const readerTitle = document.getElementById('reader-book-title');
        const readerChapter = document.getElementById('reader-chapter-title');
        const readerContent = document.getElementById('reader-content');
        const tocSidebar = document.getElementById('toc-sidebar');
        const tocList = document.getElementById('toc-list');
        let currentStoryId = null;

        function openReader(id) {
            const story = collection.find(c => c.id === id);
            if (!story) return;
            currentStoryId = id;
            readerTitle.innerText = story.englishName;
            readerChapter.innerText = story.name;
            readerContent.innerHTML = story.content; // 注入 HTML 内容
            readingMode.classList.remove('hidden');
            setTimeout(() => readingMode.classList.remove('translate-y-full'), 10);
            document.getElementById('scroll-container').style.overflow = 'hidden'; // 阻止背景滚动
        }
        function closeReader() {
            readingMode.classList.add('translate-y-full');
            setTimeout(() => {
                readingMode.classList.add('hidden');
                document.getElementById('scroll-container').style.overflow = ''; // 恢复背景滚动
            }, 300);
        }
        function toggleTOC() {
            const tocOverlay = document.getElementById('toc-overlay');
            const isOpen = !tocSidebar.classList.contains('-translate-x-full');
            if (isOpen) {
                tocSidebar.classList.add('-translate-x-full');
                tocOverlay.classList.add('hidden', 'opacity-0');
            } else {
                renderTOC();
                tocOverlay.classList.remove('hidden');
                setTimeout(() => {
                    tocSidebar.classList.remove('-translate-x-full');
                    tocOverlay.classList.remove('opacity-0');
                }, 10);
            }
        }
        function renderTOC() {
            const stories = collection.filter(i => i.category === 'story');
            tocList.innerHTML = stories.map(story => `
                <div onclick="openReader(${story.id}); toggleTOC()" class="px-6 py-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50 transition-colors">
                    <h4 class="font-serif text-sm font-bold text-gray-800">${story.name}</h4>
                </div>
            `).join('');
        }
        function prevChapter() { console.log("Previous chapter functionality triggered."); }
        function nextChapter() { console.log("Next chapter functionality triggered."); }


        // 删除了版权页相关 JS 逻辑 (openCopyright, closeCopyright, copyEmail, 滚动监听器)
        

        // =============================
        // === SSIS BACKEND DATA/LOGIC ===
        // =============================

        // SSIS 学生数据 (已整合 medicalReport 字段)
        const ALL_STUDENTS = [
            // 宋佩姿 (东华高级中学)
            { id: 2, name: "宋佩姿", idCard: "31010120060702674X", tags: ["东华市长街区", "私立东华高级中学"], 
              hometown: "上海市黄浦区", birthDate: "2006-07-02", nationalId: "1100000200607020002", localId: "DH20060002",
              image: "https://i.ibb.co/L89k31y/spz-avatar.jpg", // 学生证件照
              health: { bloodType: "B型", visionLeft: "4.8", visionRight: "4.7", height: "165 cm", weight: "50 kg", allergies: "无", medicalHistory: "无", lastCheckup: "2025-09-01", sexualHistory: { Person: "0", Count: "0", lastDate: "N/A", Position: "N/A" },
                medicalReport: {
                    title: "2025年秋季体检报告",
                    summary: "学生身体素质优秀，各项指标均在正常范围内。情绪稳定，记录显示无异常。",
                    diagnosisImage: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBVAZpIMrRmP8qpcmDTiX8bUSz5eOm6QACdgtrG0Q3CEVSNWIXVKlOsQEAAwIAA20AAzYE.png", // 诊断图片
                    findings: [
                        "1. 阴阜：水平分布型、稀疏型",
                        "2. 阴唇：浅粉色、饱满型",
                        "3. 阴蒂：完全包皮覆盖型",
                        "4. 处女膜：环状、无撕裂及缺损",
                        "5. 宫颈：低位、圆形",
                        "6. 敏感度：高"
                    ],
                    conclusion: "减少自慰次数，以提高性高潮阈值。"
                }
              },
              class: "高二(6)班", school: "私立东华高级中学", gender: "女", contact: "保密", status: "中级权限", grade: "高二", age: "17"
            },
            // 薛锦烨 (东华高级中学)
            { id: 3, name: "薛锦烨", idCard: "310101200601170921", tags: ["东华市妙华区", "私立东华高级中学"], 
              hometown: "上海市静安区", birthDate: "2006-01-17", nationalId: "1100000200601170003", localId: "DH20060003",
              image: "https://i.ibb.co/Gcz1D45/xjy-avatar.jpg", // 学生证件照
              health: { bloodType: "AB型", visionLeft: "5.1", visionRight: "5.0", height: "168 cm", weight: "55 kg", allergies: "无", medicalHistory: "轻微贫血", lastCheckup: "2025-09-01", sexualHistory: { Person: "0", Count: "0",  lastDate: "N/A", Position: "N/A" },
                medicalReport: {
                    title: "2025年秋季体检报告",
                    summary: "各项生理指标稳定，但检测到轻微的贫血迹象，建议加强营养补充。",
                    diagnosisImage: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBVAZpIMrRmP8qpcmDTiX8bUSz5eOm6QACdgtrG0Q3CEVSNWIXVKlOsQEAAwIAA20AAzYE.png", // 诊断图片
                    findings: [
                        "1. 阴阜：先天性无阴毛症",
                        "2. 阴唇：肉色、饱满型",
                        "3. 阴蒂：部分暴露型",
                        "4. 处女膜：环状、无撕裂及缺损",
                        "5. 宫颈：低位、小孔型",
                        "6. 敏感度：中"
                    ],
                    conclusion: "均衡饮食，注意矫正姿态。"
                }
              },
              class: "高二(6)班", school: "私立东华高级中学", gender: "女", contact: "保密", status: "中级权限", grade: "高二", age: "17"
            },
            // 李婧瑶 (江南大学附属高等学院)
            { id: 4, name: "李婧瑶", idCard: "320101200505201153", tags: ["东华人", "江南大学附属高等学院"], 
              hometown: "江苏省南京市", birthDate: "2005-05-20", nationalId: "3200000200505200004", localId: "DH20050016",
              image: "https://i.ibb.co/P9pSyb2/ljy-avatar.jpg", // 学生证件照
              health: { bloodType: "O型", visionLeft: "4.2", visionRight: "4.3", height: "172 cm", weight: "60 kg", allergies: "青霉素", medicalHistory: "无", lastCheckup: "2025-09-01", sexualHistory: { Person: "7", Count: "29",  lastDate: "2023-08-20", Position: "深屈曲位" },
                medicalReport: {
                    title: "2025年秋季体检报告",
                    summary: "学生身体强健，但需注意青霉素过敏史。特殊监测数据显示存在较频繁的性健康活动。",
                    diagnosisImage: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBVAZpIMrRmP8qpcmDTiX8bUSz5eOm6QACdgtrG0Q3CEVSNWIXVKlOsQEAAwIAA20AAzYE.png", // 诊断图片
                    findings: [
                        "1. 阴阜：三角分布型、正常型",
                        "2. 阴唇：粉色、扁平型",
                        "3. 阴蒂：完全包皮覆盖型",
                        "4. 处女膜：陈旧性破裂",
                        "5. 宫颈：高位、鱼嘴型",
                        "6. 敏感度：低"
                    ],
                    conclusion: "减少性伴侣数量，每3个月一次宫颈TCT+HPV分型筛查。"
                }
              },
              school: "江南大学附属高等学院", gender: "女", contact: "未知", status: "高级权限", grade: "高二", age: "18", class: "高二(1)班"
            },
            // 张琰清 (市立浅野寺国际高等学院)
            { id: 5, name: "张琰清", idCard: "320202200503038870", tags: ["东华人", "市立浅野寺国际高等学院"], 
              hometown: "江苏省无锡市", birthDate: "2005-03-03", nationalId: "3200000200503030005", localId: "DH20050017",
              image: "https://i.ibb.co/F3Y5Xy0/zyq-avatar.jpg", // 学生证件照
              health: { bloodType: "A型", visionLeft: "5.2", visionRight: "5.2", height: "163 cm", weight: "48 kg", allergies: "无", medicalHistory: "无", lastCheckup: "2025-09-01", sexualHistory: { Person: "1", Count: "13",  lastDate: "N/A", Position: "女上骑乘位" },
                medicalReport: {
                    title: "2025年秋季体检报告",
                    summary: "身体指标正常，视力极佳。但生理监测数据显示存在单人长期重复性行为记录，可能存在情绪或压力问题。",
                    diagnosisImage: "https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBVAZpIMrRmP8qpcmDTiX8bUSz5eOm6QACdgtrG0Q3CEVSNWIXVKlOsQEAAwIAA20AAzYE.png", // 诊断图片
                    findings: [
                        "1. 阴阜：水平分布型、正常型",
                        "2. 阴唇：粉色、饱满型",
                        "3. 阴蒂：完全包皮覆盖型",
                        "4. 处女膜：陈旧性破裂",
                        "5. 宫颈：高位、圆形",
                        "6. 敏感度：低"
                    ],
                    conclusion: "无。"
                }
              },
              school: "市立浅野寺国际高等学院", gender: "女", contact: "未知", status: "高级权限", grade: "高二", age: "18", class: "高二(2)班"
            },
        ];
        
        const DEFAULT_PHOTO = "https://placehold.co/300x400/34D399/FFFFFF?text=ID+Photo"; 
        
        let activeStudent = null;
        let activeTab = 'academic'; 

        // SSIS 逻辑函数
        
        function renderStudentList(filterType) {
            const listContainer = document.getElementById('student-list');
            const studentCount = document.getElementById('student-count');
            
            const filteredStudents = ALL_STUDENTS.filter(student => {
                const school = student.school;
                if (filterType === 'donghua') return school && school.includes('东华高级中学');
                if (filterType === 'jiangnan') return school && school.includes('江南大学附属高等学院');
                if (filterType === 'asano') return school && school.includes('市立浅野寺国际高等学院');
                return true; 
            });

            studentCount.innerText = filteredStudents.length;
            listContainer.innerHTML = filteredStudents.map(student => `
                <div id="student-card-${student.id}" onclick="selectStudent(${student.id})" 
                    class="student-list-item cursor-pointer p-4 bg-white rounded-lg shadow-sm border border-gray-100 hover:bg-indigo-50 transition-all duration-200">
                    <div class="flex items-center gap-4">
                        <img src="${student.image}" alt="${student.name} Photo" 
                            onerror="this.onerror=null; this.src='${DEFAULT_PHOTO}';" 
                            class="w-12 h-12 object-cover rounded-full border-2 border-gray-200 shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-semibold truncate">${student.name}</p>
                            <p class="text-xs text-gray-500 truncate">${student.idCard} | ${student.school || '未知学校'}</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
            // 在 SSIS 模态框打开时，确保选中状态正确
            if (activeStudent && filteredStudents.find(s => s.id === activeStudent.id)) {
                setTimeout(() => selectStudent(activeStudent.id), 0);
            }
        }
        
        function filterStudents(type) {
            // 注意：这里使用 #ssis-modal-overlay 来限定范围，避免影响其他元素
            document.querySelectorAll('#ssis-modal-overlay .sidebar-link').forEach(btn => {
                btn.classList.remove('bg-primary-blue', 'text-white', 'font-semibold', 'hover:bg-indigo-700');
                btn.classList.add('text-gray-600', 'font-medium', 'hover:bg-gray-100', 'hover:text-gray-800');
            });
            
            const activeBtn = document.querySelector(`#ssis-modal-overlay .sidebar-link[onclick="filterStudents('${type}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-primary-blue', 'text-white', 'font-semibold', 'hover:bg-indigo-700');
            }
            
            renderStudentList(type);
        }

        function selectStudent(id) {
            activeStudent = ALL_STUDENTS.find(s => s.id === id);
            if (!activeStudent) return;
            
            document.querySelectorAll('.student-list-item').forEach(item => {
                item.classList.remove('bg-indigo-100', 'border-primary-blue');
                item.classList.add('bg-white', 'border-gray-100');
            });
            const currentItem = document.getElementById(`student-card-${id}`);
            if (currentItem) {
                currentItem.classList.remove('bg-white', 'border-gray-100');
                currentItem.classList.add('bg-indigo-100', 'border-primary-blue');
            }

            document.getElementById('detail-panel-header').classList.remove('hidden');
            document.getElementById('detail-tabs').classList.remove('hidden');
            document.getElementById('detail-name').innerText = activeStudent.name;
            
            document.getElementById('detail-role').innerText = activeStudent.idCard;
            
            document.getElementById('detail-tags').innerHTML = activeStudent.tags.map(tag => `
                <span class="px-3 py-0.5 bg-gray-100 text-gray-600 text-xs tracking-wider rounded">${tag}</span>
            `).join('');

            switchDetailTab(activeTab);
        }

        function switchDetailTab(tabName) {
            activeTab = tabName;
            const contentContainer = document.getElementById('detail-content');
            
            document.querySelectorAll('#ssis-modal-overlay .tab-btn').forEach(btn => { // 增加 #ssis-modal-overlay 范围限定
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('border-primary-blue', 'text-primary-blue', 'font-semibold');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'font-medium', 'hover:border-gray-300');
                } else {
                    btn.classList.remove('border-primary-blue', 'text-primary-blue', 'font-semibold');
                    btn.classList.add('border-transparent', 'text-gray-500', 'font-medium', 'hover:border-gray-300');
                }
            });

            if (!activeStudent) {
                contentContainer.innerHTML = '请从左侧选择一名学生查看档案。';
                return;
            }

            if (tabName === 'card') {
                contentContainer.className = 'min-h-[60vh] flex items-center justify-center p-8';
                contentContainer.innerHTML = renderStudentCard(activeStudent);
                lucide.createIcons();
            } else if (tabName === 'academic') { 
                contentContainer.className = 'min-h-[60vh] p-8 space-y-8';
                contentContainer.innerHTML = renderAcademicDossier(activeStudent);
                lucide.createIcons();
            } else if (tabName === 'health') { 
                contentContainer.className = 'min-h-[60vh] p-8 space-y-8';
                contentContainer.innerHTML = renderHealthDossier(activeStudent);
                lucide.createIcons();
            }
        }
        
        function renderStudentCard(student) {
            const studentId = `DH${String(student.id).padStart(6, '0')}`;
            const schoolName = student.school || '未知学校';
            const department = student.class || '未知班级';

            const infoFields = [
                { key: '姓名 (Name)', value: student.name },
                { key: '性别 (Gender)', value: student.gender || '-' }, 
                { key: '年龄 (Age)', value: student.age || '-' }, 
                { key: '班级 (Class)', value: department },
            ];

            const infoHtml = infoFields.map(field => `
                <div class="p-2 border-b border-gray-200 flex justify-between">
                    <span class="text-xs text-gray-500">${field.key}</span>
                    <span class="text-sm font-semibold text-gray-800">${field.value}</span>
                </div>
            `).join('');

            return `
                <div class="w-full student-id-card p-6 rounded-xl shadow-2xl shrink-0 border-t-8 border-primary-blue">
                    <div class="flex justify-between items-center border-b border-gray-300 pb-3 mb-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="graduation-cap" class="w-5 h-5 text-primary-blue"></i>
                            <h4 class="text-base font-bold text-primary-blue tracking-wider">东华市教育局统一学籍卡</h4>
                        </div>
                        <div class="text-right">
                             <span class="text-[10px] text-primary-blue font-mono font-bold tracking-widest bg-indigo-50 border border-indigo-200 px-1.5 py-1 rounded">${studentId}</span>
                        </div>
                    </div>

                    <div class="flex gap-6">
                        <div class="w-1/3 aspect-[3/4] overflow-hidden shrink-0 border-2 border-gray-300 shadow-md">
                            <img src="${student.image}" alt="${student.name} Portrait" class="w-full h-full student-id-photo" onerror="this.onerror=null; this.src='${DEFAULT_PHOTO}';">
                        </div>

                        <div class="flex-1 flex flex-col justify-start space-y-2">
                            <div class="mb-2 bg-gray-50 rounded-lg border border-gray-200">
                                ${infoHtml}
                            </div>
                            <div class="p-2 bg-yellow-50 rounded-lg border border-yellow-200">
                                <span class="text-xs text-yellow-700 font-bold">学校：${schoolName}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-200 w-full text-center">
                        <div class="w-full text-xs text-gray-500 font-mono tracking-widest">
                            <p>${student.status || '正常'} | 数据更新于 2025.11.21</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAcademicDossier(student) {
            const officialDetails = [
                { key: '档案编号', value: `FILE-DH-${String(student.id).padStart(5, '0')}` },
                { key: '姓名', value: student.name }, 
                { key: '身份证号', value: student.idCard }, 
                { key: '出生日期', value: student.birthDate || '未知' }, 
                { key: '籍贯', value: student.hometown || '未知' }, 
                { key: '全国学籍号', value: student.nationalId || 'N/A' }, 
                { key: '东华市学籍号', value: student.localId || 'N/A' }, 
                { key: '当前学校', value: student.school || '未知' },
                { key: '当前班级', value: student.class || '未知' },
                { key: '档案状态', value: student.status || '正常' },
            ];
            
            const officialHtml = officialDetails.map(item => `
                <div class="dossier-item">
                    <span class="text-sm font-medium text-gray-500">${item.key}</span>
                    <span class="text-sm font-bold text-gray-700">${item.value}</span>
                </div>
            `).join('');

            return `
                <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-primary-blue space-y-6">
                    <h4 class="text-xl font-bold text-gray-800 border-b pb-2 flex items-center gap-2">
                        <i data-lucide="scroll-text" class="w-5 h-5 text-primary-blue"></i>
                        基础学籍信息
                    </h4>
                    <div class="divide-y divide-gray-100">
                        ${officialHtml}
                    </div>
                </div>
            `;
        }
        
        function renderHealthDossier(student) {
            const healthData = student.health;
            
            const basicHealthDetails = [
                { key: '血型', value: healthData.bloodType || 'N/A' },
                { key: '左眼视力', value: healthData.visionLeft || 'N/A' },
                { key: '右眼视力', value: healthData.visionRight || 'N/A' },
                { key: '身高', value: healthData.height || 'N/A' },
                { key: '体重', value: healthData.weight || 'N/A' },
                { key: '药物/食物过敏史', value: healthData.allergies || '无' },
                { key: '既往病史', value: healthData.medicalHistory || '无' },
                { key: '最近体检日期', value: healthData.lastCheckup || 'N/A' },
                { key: '学籍档案状态', value: student.status || '正常' },
            ];

            const basicHealthHtml = basicHealthDetails.map(item => `
                <div class="dossier-item">
                    <span class="text-sm font-medium text-gray-500">${item.key}</span>
                    <span class="text-sm font-bold text-gray-700">${item.value}</span>
                </div>
            `).join('');
            
            const sexualHealthDetails = [
                { key: '性经历 (人次)', value: healthData.sexualHistory.Person },
                { key: '性经历 (次数)', value: healthData.sexualHistory.Count },
                { key: '最近一次性行为', value: healthData.sexualHistory.lastDate },
                { key: '擅长体位', value: healthData.sexualHistory.Position },
            ];
            
            const sexualHealthHtml = sexualHealthDetails.map(item => `
                <div class="dossier-item">
                    <span class="text-sm font-medium text-gray-500">${item.key}</span>
                    <span class="text-sm font-bold text-gray-700">${item.value}</span>
                </div>
            `).join('');


            return `
                <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-green-500 space-y-6">
                    <h4 class="text-xl font-bold text-gray-800 border-b pb-2 flex items-center gap-2">
                        <i data-lucide="heart-pulse" class="w-5 h-5 text-green-600"></i>
                        基础体检数据
                    </h4>
                    <div class="divide-y divide-gray-100">
                        ${basicHealthHtml}
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-red-500 mt-8">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h4 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="microscope" class="w-5 h-5 text-red-600"></i>
                            生理监测数据 (性健康监测)
                        </h4>
                        <button onclick="openReportModal(${student.id})" class="text-sm font-semibold text-red-600 hover:text-red-700 transition-colors flex items-center gap-1 p-1 rounded hover:bg-red-50">
                            体检报告 <i data-lucide="file-text" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="divide-y divide-gray-100 mb-2">
                        ${sexualHealthHtml}
                    </div>
                    <p class="mt-4 text-sm text-gray-500">
                        注意：此项数据敏感，由东华市教育安全部门进行统一采集和记录。
                    </p>
                </div>
            `;
        }

        function openReportModal(studentId) {
            const student = ALL_STUDENTS.find(s => s.id === studentId);
            if (!student || !student.health.medicalReport) return;
            
            const report = student.health.medicalReport;
            const modal = document.getElementById('report-modal-overlay');
            const content = document.getElementById('report-modal-content');

            document.getElementById('report-title').innerText = report.title;
            document.getElementById('report-student-name').innerText = student.name;
            document.getElementById('report-summary').innerText = report.summary;
            
            document.getElementById('report-diagnosis-image').src = report.diagnosisImage;
            
            document.getElementById('report-findings').innerHTML = report.findings.map(f => `
                <li class="p-2 bg-white rounded-md border border-gray-100 shadow-sm text-gray-700">${f}</li>
            `).join('');
            
            document.getElementById('report-conclusion').innerText = report.conclusion;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
            }, 10);
            document.body.style.overflow = 'hidden'; 
            lucide.createIcons(); 
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal-overlay');
            const content = document.getElementById('report-modal-content');
            
            content.classList.add('scale-95');
            modal.classList.add('opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; 
            }, 300);
        }

        function initSSIS() {
            // 在 SSIS 模态框打开时调用，以确保数据和 UI 状态正确
            renderStudentList('all');
        }
        
        // === Initialization ===
        document.addEventListener('DOMContentLoaded', () => {
            filterGallery('character');
            renderStories();
            lucide.createIcons();
            
            // 只需要初始化 SSIS 的数据，但不需要在 DOMContentLoaded 时显示它
            initSSIS();
        });
    </script>
</body>
</html>