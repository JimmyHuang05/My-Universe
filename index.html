<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CampusHub - æ ¡å›­ç”Ÿæ´»åœˆ</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ FontAwesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- é…ç½® Tailwind ä¸»é¢˜ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // è“è‰²ä¸»è‰²è°ƒ
                        secondary: '#64748b',
                        surface: '#ffffff',
                        background: '#f8fafc',
                        bilibili: '#FB7299', // ä»¿Bç«™ç²‰è‰²
                        treehole: '#10b981', // æ ‘æ´ç»¿è‰²
                        market: '#f97316',   // é›†å¸‚æ©™è‰²
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* å…¨å±€éšè—æ»šåŠ¨æ¡ */
        html, body {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }
        html::-webkit-scrollbar, body::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Webkit */
        }

        /* ç®€å•çš„ç‚¹èµåŠ¨ç”» */
        .like-anim {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .like-anim:active {
            transform: scale(1.3);
        }
        .liked {
            color: #ef4444; /* å¸–å­ç‚¹èµçº¢ */
        }
        .comment-liked {
            color: #FB7299; /* è¯„è®ºç‚¹èµç²‰ */
        }

        /* --- å…¨å±ç›´æ¥é«˜æ–¯æ¨¡ç³Šæ•ˆæœ --- */
        .full-screen-backdrop {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            -webkit-backdrop-filter: blur(0px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, backdrop-filter 0.5s ease;
        }

        .full-screen-backdrop.active {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            opacity: 1;
            pointer-events: auto;
        }

        /* --- å‘å¸–é¢æ¿çš„ç¼“åŠ¨æ•ˆæœ --- */
        .modal-panel {
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease;
        }

        /* åº•éƒ¨å¯¼èˆªæ åœ¨æ¡Œé¢ç«¯éšè— */
        @media (min-width: 768px) {
            .mobile-nav { display: none; }
            .desktop-nav { display: flex; }
            .fab-button { display: none; }
        }
        
        @media (max-width: 767px) {
            .mobile-nav { display: flex; }
            .desktop-nav { display: none; }
            body { padding-bottom: 80px; }
        }

        /* è¯„è®ºåŒºåŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-background text-gray-800 font-sans antialiased selection:bg-primary selection:text-white">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="fixed top-0 w-full z-40 bg-surface/90 backdrop-blur-md border-b border-gray-100 shadow-sm transition-all duration-300" id="header">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.scrollTo(0,0); openFeed();">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-lg">C</div>
                <span class="text-xl font-bold tracking-tight text-gray-900">CampusHub<sup class="text-xs text-primary ml-1 font-medium">Beta 0.2.1</sup></span>
            </div>

            <div class="desktop-nav items-center gap-6">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="æœç´¢æ ‡é¢˜æˆ–åˆ›ä½œè€…..." class="pl-9 pr-4 py-2 bg-gray-100 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 w-64 transition-all">
                </div>
                <nav class="flex gap-6 text-sm font-medium text-gray-600">
                    <a href="javascript:void(0)" onclick="openFeed()" id="nav-square" class="hover:text-primary transition-colors text-primary font-bold">å¹¿åœº</a>
                    <a href="javascript:void(0)" onclick="openTreeHole()" id="nav-treehole" class="hover:text-primary transition-colors">æ ‘æ´</a>
                    <a href="javascript:void(0)" onclick="openMarket()" id="nav-market" class="hover:text-primary transition-colors">é›†å¸‚</a>
                </nav>
                <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
                    <button class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                        <i class="fa-regular fa-bell text-gray-600 text-sm"></i>
                    </button>
                    <!-- å½“å‰ç”¨æˆ·å¤´åƒ (User) -->
                    <div id="desktop-user-avatar">
                        <!-- JSå°†åœ¨æ­¤æ’å…¥å¤´åƒ -->
                    </div>
                    <button onclick="toggleModal('postModal')" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm font-medium transition-colors shadow-lg shadow-blue-500/30">
                        å‘å¸–
                    </button>
                </div>
            </div>

            <div class="md:hidden flex items-center gap-3">
                <button class="w-8 h-8 flex items-center justify-center text-gray-600">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <!-- ç§»åŠ¨ç«¯å½“å‰ç”¨æˆ·å¤´åƒ -->
                <div id="mobile-user-avatar">
                    <!-- JSå°†åœ¨æ­¤æ’å…¥å¤´åƒ -->
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="max-w-6xl mx-auto px-4 pt-20 grid grid-cols-1 md:grid-cols-12 gap-6 relative">
        
        <!-- å·¦ä¾§/ä¸»è¦å†…å®¹æµ -->
        <div class="md:col-span-8 lg:col-span-8 transition-all duration-300">
            
            <!-- 1. å¹¿åœº/ä¸»åˆ—è¡¨è§†å›¾å®¹å™¨ -->
            <div id="main-feed-view">
                <!-- æ’åºå·¥å…·æ  -->
                <div class="flex items-center justify-between mb-4 px-1">
                    <h3 class="font-bold text-gray-900 text-lg flex items-center gap-2">
                        <span id="feed-title">æœ€æ–°åŠ¨æ€</span>
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>
                    </h3>
                    <div class="flex gap-4 text-sm text-gray-500 bg-white px-3 py-1.5 rounded-full border border-gray-100 shadow-sm">
                        <button id="feed-sort-hot" class="font-bold text-gray-900 cursor-pointer transition-colors flex items-center gap-1" onclick="switchFeedSortOrder('hot')">
                            <i class="fa-solid fa-fire text-xs text-red-500"></i> çƒ­é—¨
                        </button>
                        <div class="w-[1px] h-3 bg-gray-200 self-center"></div>
                        <button id="feed-sort-new" class="cursor-pointer hover:text-gray-900 transition-colors flex items-center gap-1" onclick="switchFeedSortOrder('new')">
                            <i class="fa-regular fa-clock text-xs"></i> æœ€æ–°
                        </button>
                    </div>
                </div>

                <div id="post-feed" class="space-y-4">
                    <!-- å¸–å­å°†é€šè¿‡JSæ’å…¥è¿™é‡Œ -->
                    <div class="py-12 text-center text-gray-400">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>æ­£åœ¨åŠ è½½å†…å®¹...</p>
                    </div>
                </div>
                <div class="py-8 text-center hidden" id="feed-loading-state">
                    <button id="load-more" class="text-sm text-gray-500 hover:text-primary flex items-center justify-center gap-2 mx-auto">
                        <span>åŠ è½½æ›´å¤šå†…å®¹</span>
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- 2. å¸–å­è¯¦æƒ…è§†å›¾ (é»˜è®¤éšè—) -->
            <div id="post-detail-view" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 min-h-[500px]">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JSåŠ¨æ€æ’å…¥ -->
            </div>

            <!-- 3. ä¸ªäººä¸»é¡µè§†å›¾ (é»˜è®¤éšè—) -->
            <div id="user-profile-view" class="hidden flex-col gap-4">
                <!-- ä¸ªäººèµ„æ–™å¡ç‰‡ -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative">
                    <!-- èƒŒæ™¯å›¾ -->
                    <div class="h-32 bg-gradient-to-r from-blue-400 to-indigo-500 relative">
                        <button onclick="closeProfile()" class="absolute top-4 left-4 w-8 h-8 bg-black/20 hover:bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white transition-colors z-10">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <div class="px-6 pb-6">
                        <div class="flex justify-between items-end -mt-10 mb-4">
                            <!-- å¤´åƒå®¹å™¨ -->
                            <div id="profile-avatar-container" class="relative">
                                <!-- JS æ’å…¥å¤§å¤´åƒ -->
                            </div>
                            <button class="bg-white border border-gray-200 text-gray-700 px-4 py-1.5 rounded-full text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
                                ç¼–è¾‘èµ„æ–™
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                User 
                                <span class="text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full font-bold">LV.5</span>
                            </h2>
                            <p class="text-gray-500 text-sm mt-1" id="profile-sign">è¿™é‡Œæ˜¯ä¸ªäººç­¾åï¼Œçƒ­çˆ±ç”Ÿæ´»ï¼Œçƒ­çˆ±æ ¡å›­ã€‚</p>
                        </div>

                        <div class="flex gap-6 border-t border-gray-50 pt-4">
                            <div class="text-center">
                                <div class="text-lg font-bold text-gray-900" id="profile-stats-posts">0</div>
                                <div class="text-xs text-gray-400">å¸–å­</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-gray-900">128</div>
                                <div class="text-xs text-gray-400">å…³æ³¨</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-gray-900">356</div>
                                <div class="text-xs text-gray-400">ç²‰ä¸</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-gray-900" id="profile-stats-likes">0</div>
                                <div class="text-xs text-gray-400">è·èµ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸ªäººåŠ¨æ€åˆ—è¡¨ -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 min-h-[300px] p-2">
                    <div class="flex items-center gap-6 border-b border-gray-100 px-4">
                        <button class="py-4 text-sm font-bold text-primary border-b-2 border-primary">æˆ‘çš„åŠ¨æ€</button>
                        <button class="py-4 text-sm font-medium text-gray-500 hover:text-gray-900 transition-colors">å›å¤</button>
                        <button class="py-4 text-sm font-medium text-gray-500 hover:text-gray-900 transition-colors">ç‚¹èµ</button>
                    </div>
                    <div id="profile-posts-list" class="p-2 space-y-4 mt-2">
                        <!-- JS æ’å…¥æˆ‘çš„å¸–å­ -->
                    </div>
                </div>
            </div>

            <!-- 4. è¯é¢˜è¯¦æƒ…è§†å›¾ (é»˜è®¤éšè—) -->
            <div id="topic-detail-view" class="hidden flex-col gap-4">
                 <!-- è¯é¢˜ Banner å°†ç”± JS åŠ¨æ€æ¸²æŸ“ -->
                 <div id="topic-header-container"></div>

                <!-- è¯é¢˜ä¸‹çš„å¸–å­åˆ—è¡¨ -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 min-h-[500px] p-2">
                    <div class="flex items-center gap-6 border-b border-gray-100 px-4 mb-2">
                        <button id="topic-sort-hot" class="py-4 text-sm font-bold text-gray-900 border-b-2 border-gray-900 cursor-pointer">çƒ­é—¨</button>
                        <button id="topic-sort-new" class="py-4 text-sm font-medium text-gray-500 hover:text-gray-900 transition-colors cursor-pointer">å®æ—¶</button>
                    </div>
                    <div id="topic-posts-feed" class="space-y-4">
                        <!-- JS æ’å…¥è¯é¢˜å¸–å­ -->
                    </div>
                </div>
            </div>
            
            <!-- 5. æ ‘æ´è§†å›¾ (é»˜è®¤éšè—) -->
            <div id="tree-hole-view" class="hidden flex-col gap-4">
                <!-- æ ‘æ´ Banner -->
                <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 shadow-md text-white relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i class="fa-solid fa-tree text-xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold">æ ‘æ´ Â· åŒ¿ååæ§½</h2>
                        </div>
                        <p class="text-emerald-50 text-sm opacity-90 max-w-lg">
                            åœ¨è¿™é‡Œï¼Œæˆ´ä¸Šé¢å…·ï¼Œå¸ä¸‹é˜²å¤‡ã€‚æ‰€æœ‰çš„çƒ¦æ¼ã€ç§˜å¯†å’Œåæ§½éƒ½å¯ä»¥ç•™åœ¨è¿™é‡Œã€‚
                        </p>
                    </div>
                    <!-- è£…é¥°å›¾æ ‡ -->
                    <i class="fa-solid fa-comments absolute -bottom-4 -right-4 text-9xl text-white/10 rotate-12"></i>
                </div>

                <!-- æ ‘æ´åˆ—è¡¨ -->
                <div id="tree-hole-feed" class="space-y-4">
                    <!-- JS æ’å…¥æ ‘æ´å¸–å­ -->
                </div>
                
                <div class="py-8 text-center text-gray-400 text-xs">
                    <p>åˆ°åº•äº†ï¼Œç§˜å¯†å°±è¿™ä¹ˆå¤š ~</p>
                </div>
            </div>

            <!-- 6. é›†å¸‚è§†å›¾ (é»˜è®¤éšè—) -->
            <div id="market-view" class="hidden flex-col gap-4">
                <!-- é›†å¸‚ Header -->
                <div class="flex items-center justify-between px-2">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                            <span class="text-market">ğŸ›ï¸</span> æ ¡å›­é›†å¸‚
                        </h2>
                        <p class="text-xs text-gray-500 mt-1">äºŒæ‰‹ä¹¦ã€é—²ç½®å¥½ç‰©ã€æ±‚è´­ä¿¡æ¯</p>
                    </div>
                    <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-xs font-bold transition-colors">
                        å‘å¸ƒé—²ç½®
                    </button>
                </div>

                <!-- åˆ†ç±»æ ‡ç­¾ -->
                <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide" id="market-tabs">
                    <button onclick="filterMarket('all')" class="market-tab-btn flex-shrink-0 bg-market text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-sm shadow-orange-200" data-category="all">å…¨éƒ¨</button>
                    <button onclick="filterMarket('äºŒæ‰‹ä¹¦')" class="market-tab-btn flex-shrink-0 bg-white border border-gray-200 text-gray-600 px-4 py-1.5 rounded-full text-sm font-medium hover:border-market hover:text-market transition-colors" data-category="äºŒæ‰‹ä¹¦">äºŒæ‰‹ä¹¦/æ•™æ</button>
                    <button onclick="filterMarket('æ•°ç ')" class="market-tab-btn flex-shrink-0 bg-white border border-gray-200 text-gray-600 px-4 py-1.5 rounded-full text-sm font-medium hover:border-market hover:text-market transition-colors" data-category="æ•°ç ">æ•°ç äº§å“</button>
                    <button onclick="filterMarket('ç”Ÿæ´»')" class="market-tab-btn flex-shrink-0 bg-white border border-gray-200 text-gray-600 px-4 py-1.5 rounded-full text-sm font-medium hover:border-market hover:text-market transition-colors" data-category="ç”Ÿæ´»">ç”Ÿæ´»ç”¨å“</button>
                    <button onclick="filterMarket('æ±‚è´­')" class="market-tab-btn flex-shrink-0 bg-white border border-gray-200 text-gray-600 px-4 py-1.5 rounded-full text-sm font-medium hover:border-market hover:text-market transition-colors" data-category="æ±‚è´­">æ±‚è´­</button>
                </div>

                <!-- å•†å“åˆ—è¡¨ (Grid) -->
                <div id="market-feed" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- JS æ’å…¥å•†å“ -->
                </div>
                
                <div class="py-8 text-center text-gray-400 text-xs">
                    <p>æ²¡æœ‰æ›´å¤šå•†å“äº†</p>
                </div>
            </div>

        </div>

        <!-- å³ä¾§ä¾§è¾¹æ  (ä»…æ¡Œé¢ç«¯æ˜¾ç¤º) -->
        <aside class="hidden md:block md:col-span-4 lg:col-span-4 space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-900 mb-2">ğŸ‘‹ æ¬¢è¿å›åˆ° CampusHub</h3>
                <p class="text-sm text-gray-500 leading-relaxed mb-4">
                    è¿™é‡Œæ˜¯å±äºæˆ‘ä»¬è‡ªå·±çš„æ ¡å›­ç”Ÿæ´»åœˆã€‚æ— è®ºæ˜¯é€‰è¯¾é¿é›·ã€å¯»æ‰¾é¥­æ­å­è¿˜æ˜¯äºŒæ‰‹äº¤æ˜“ï¼Œéƒ½åœ¨è¿™é‡Œï¼
                </p>
                <div class="flex gap-4 text-center">
                    <div class="flex-1 bg-indigo-50 rounded-lg py-2">
                        <div class="text-lg font-bold text-indigo-600">2.5k</div>
                        <div class="text-xs text-gray-500">æ ¡å‹</div>
                    </div>
                    <div class="flex-1 bg-indigo-50 rounded-lg py-2">
                        <div class="text-lg font-bold text-indigo-600">20+</div>
                        <div class="text-xs text-gray-500">ä»Šæ—¥æ–°å¸–</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-fire text-red-500"></i> å…¨æ ¡çƒ­æ¦œ
                </h3>
                <ul class="space-y-4">
                    <li class="flex items-start gap-3 cursor-pointer group" onclick="openTopic(1)">
                        <span class="text-lg font-bold text-red-500 group-hover:text-primary transition-colors">1</span>
                        <div>
                            <p class="text-sm font-medium text-gray-800 group-hover:text-primary transition-colors line-clamp-1">æœŸæœ«è€ƒè¯•å»¶æœŸ? æ•™åŠ¡å¤„å›åº”</p>
                            <span class="text-xs text-gray-400">æ•™åŠ¡å¤„è¾Ÿè°£ï¼Œç½‘ä¼ æ¶ˆæ¯ä¸å®ã€‚</span>
                        </div>
                    </li>
                    <li class="flex items-start gap-3 cursor-pointer group" onclick="openTopic(2)">
                        <span class="text-lg font-bold text-orange-500 group-hover:text-primary">2</span>
                        <div>
                            <p class="text-sm font-medium text-gray-800 group-hover:text-primary transition-colors line-clamp-1">é£Ÿå ‚æ–°å¼€â€œè‡ªé€‰ç§°é‡â€çª—å£è¯„ä»·</p>
                            <span class="text-xs text-gray-400">å¸ˆç”Ÿçƒ­è®®ï¼Œæ€§ä»·æ¯”é«˜ä½†æ’é˜Ÿè¾ƒé•¿ã€‚</span>
                        </div>
                    </li>
                    <li class="flex items-start gap-3 cursor-pointer group" onclick="openTopic(3)">
                        <span class="text-lg font-bold text-yellow-500 group-hover:text-primary">3</span>
                        <div>
                            <p class="text-sm font-medium text-gray-800 group-hover:text-primary transition-colors line-clamp-1">é«˜ä¸‰æœŸä¸­æˆç»©åˆ†æä¼šç›´æ’­å›æ”¾</p>
                            <span class="text-xs text-gray-400">ç­ä¸»ä»»è¯¦ç»†è®²è§£æœ¬æ¬¡è€ƒè¯•è¶‹åŠ¿ã€‚</span>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs text-gray-400 px-2">
                <a href="#" class="hover:underline">å…³äºæˆ‘ä»¬</a>
                <a href="#" class="hover:underline">ç”¨æˆ·åè®®</a>
                <a href="#" class="hover:underline">éšç§æ”¿ç­–</a>
                <span>Â© 2023 Nexus Inc.</span>
            </div>
        </aside>

    </main>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨æ‚¬æµ®å‘å¸ƒæŒ‰é’® -->
    <button onclick="toggleModal('postModal')" class="fab-button fixed bottom-20 right-4 w-14 h-14 bg-primary text-white rounded-full shadow-lg shadow-blue-500/40 flex items-center justify-center text-xl z-30 active:scale-95 transition-transform">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="mobile-nav fixed bottom-0 w-full bg-white border-t border-gray-100 pb-safe z-40 justify-around items-center h-16 text-xs text-gray-500">
        <a href="javascript:void(0)" onclick="openFeed()" class="flex flex-col items-center gap-1 w-full h-full justify-center text-primary" id="nav-home-mobile">
            <i class="fa-solid fa-house text-lg"></i>
            <span>é¦–é¡µ</span>
        </a>
        <a href="javascript:void(0)" onclick="openTreeHole()" class="flex flex-col items-center gap-1 w-full h-full justify-center hover:text-gray-900 transition-colors" id="nav-treehole-mobile">
            <i class="fa-solid fa-tree text-lg"></i>
            <span>æ ‘æ´</span>
        </a>
        <a href="javascript:void(0)" onclick="openMarket()" class="flex flex-col items-center gap-1 w-full h-full justify-center hover:text-gray-900 transition-colors" id="nav-market-mobile">
            <i class="fa-solid fa-store text-lg"></i>
            <span>é›†å¸‚</span>
        </a>
        <a href="#" class="flex flex-col items-center gap-1 w-full h-full justify-center hover:text-gray-900 transition-colors">
            <i class="fa-regular fa-user text-lg"></i>
            <span>æˆ‘çš„</span>
        </a>
    </nav>

    <!-- å‘å¸–æ¨¡æ€æ¡† -->
    <div id="postModal" class="fixed inset-0 z-50 hidden flex flex-col items-center justify-center">
        <div id="modalBackdrop" class="full-screen-backdrop" onclick="toggleModal('postModal')"></div>
        <div id="modalPanel" class="modal-panel bg-white w-full max-w-lg md:w-[600px] rounded-2xl shadow-2xl p-6 flex flex-col max-h-[90vh] z-10 transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">å‘å¸ƒæ–°åŠ¨æ€</h3>
                <button onclick="toggleModal('postModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <input type="text" placeholder="åŠ ä¸ªå¸ç›çš„æ ‡é¢˜ (å¿…å¡«)" class="w-full text-lg font-bold border-none focus:ring-0 focus:outline-none caret-primary placeholder:text-gray-300 px-0 mb-4 bg-transparent">
            <textarea placeholder="åˆ†äº«ä½ çš„æ ¡å›­ç”Ÿæ´»ã€åæ§½ã€æˆ–è€…æ±‚åŠ©..." class="w-full flex-1 min-h-[150px] resize-none border-none focus:ring-0 focus:outline-none caret-primary text-gray-600 px-0 bg-transparent text-base" id="postContent"></textarea>
            <div class="flex gap-2 mb-6 overflow-x-auto py-2">
                <span class="px-3 py-1 rounded-full bg-gray-100 text-xs text-gray-500 flex items-center gap-1 cursor-pointer hover:bg-gray-200">
                    <i class="fa-solid fa-hashtag text-gray-400"></i> è¯é¢˜
                </span>
                <span class="px-3 py-1 rounded-full bg-yellow-50 text-yellow-600 text-xs border border-yellow-100">æ±‚åŠ©ä¸‡èƒ½çš„æ ¡å‹</span>
                <span class="px-3 py-1 rounded-full bg-blue-50 text-blue-600 text-xs border border-blue-100">é—²ç½®äº¤æ˜“</span>
            </div>
            <div class="flex justify-between items-center border-t border-gray-100 pt-4">
                <div class="flex gap-4 text-gray-400 text-lg">
                    <button class="hover:text-primary"><i class="fa-regular fa-image"></i></button>
                    <button class="hover:text-primary"><i class="fa-solid fa-link"></i></button>
                    <button class="hover:text-primary"><i class="fa-regular fa-face-smile"></i></button>
                </div>
                <button onclick="submitPost()" class="bg-gray-900 hover:bg-gray-800 text-white px-6 py-2 rounded-full text-sm font-medium transition-colors">
                    å‘å¸ƒ
                </button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·è¯¦æƒ…æ‚¬æµ®å¡ç‰‡ -->
    <div id="user-popover" class="absolute z-30 w-80 bg-white rounded-xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.2)] overflow-hidden transition duration-300 opacity-0 pointer-events-none scale-95 origin-top-left border border-gray-100" style="left: -999px; top: -999px;" onmouseenter="cancelHideUserCard()" onmouseleave="hideUserCardDelay()">
         <div class="p-6 relative">
             <div class="flex flex-col relative min-h-[80px]">
                 <div id="popover-avatar-container" class="relative z-10 w-16 h-16 rounded-full border border-gray-50 bg-white cursor-pointer mb-2"></div>
                 <div id="popover-anim-content" class="transition-all duration-500 ease-out origin-left">
                     <h3 class="font-bold text-lg text-gray-900 flex items-center gap-2">
                         <span id="popover-name">User</span>
                         <img id="popover-level" src="" class="h-9 w-auto hidden" alt="Lv">
                     </h3>
                     <div id="popover-stats" class="transition-opacity duration-500 delay-100 opacity-0 mt-3 space-y-3">
                         <div class="flex items-center gap-5 text-xs text-gray-500">
                             <div class="hover:text-primary transition-colors cursor-pointer"><span class="font-bold text-gray-900 text-sm" id="popover-following">0</span> å…³æ³¨</div>
                             <div class="hover:text-primary transition-colors cursor-pointer"><span class="font-bold text-gray-900 text-sm" id="popover-fans">0</span> ç²‰ä¸</div>
                             <div class="hover:text-primary transition-colors cursor-pointer"><span class="font-bold text-gray-900 text-sm" id="popover-likes">0</span> è·èµ</div>
                         </div>
                         <p class="text-xs text-gray-400 line-clamp-2 leading-relaxed" id="popover-sign">è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å†™ã€‚</p>
                     </div>
                 </div>
             </div>
             <div class="mt-4 pt-3 border-t border-gray-50 flex justify-between items-center opacity-0 transition-opacity duration-500 delay-200" id="popover-footer">
                 <button class="text-xs font-bold text-gray-600 hover:text-primary transition-colors px-4 py-1.5 rounded hover:bg-gray-100 border border-transparent hover:border-gray-200">å‘æ¶ˆæ¯</button>
                 <button class="bg-primary hover:bg-blue-600 text-white text-xs font-bold px-6 py-1.5 rounded-full shadow-md shadow-blue-200/50 transition-all hover:shadow-blue-300/60 active:scale-95" onclick="showToast('å·²å…³æ³¨')">
                    + å…³æ³¨
                 </button>
             </div>
         </div>
    </div>

    <!-- é€šçŸ¥ Toast -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-msg">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        // -------------------------
        // å¤´åƒç”Ÿæˆå·¥å…·å‡½æ•°
        // -------------------------
        
        const pinyinMap = { 'é»„': 'H', 'éª†': 'L', 'å': 'H', 'å‡': 'N', 'å­': 'Z', 'æ€¡': 'Y', 'å©§': 'J', 'ç‘¶': 'Y', 'é”¦': 'J', 'çƒ¨': 'Y', 'ç°': 'Y', 'æ¸…': 'Q', 'ä»»': 'R', 'ä½³': 'J', 'å¯': 'K', 'ä¾': 'Y', 'éƒ': 'Y', 'å”¯': 'W', 'äº¦': 'Y', 'å©•': 'J', 'é›¨': 'Y', 'è²': 'F', 'èŠ¯': 'X', 'æ…ˆ': 'C', 'è¯£': 'Y', 'èŒ—': 'M', 'ä½©': 'P', 'å§¿': 'Z', 'ç¥º': 'Q', 'è¶Š': 'Y', 'å®˜': 'G', 'ç‹': 'W', 'è°­': 'T', 'å®‹': 'S', 'å¹´': 'N', 'èƒ¡': 'H', 'ç”°': 'T', 'é©¬': 'M', 'è¢': 'Y', 'æ¹˜': 'X', 'ç´': 'Q', 'èŠ±': 'H', 'æ³½': 'Z', 'ç±»': 'L', 'é“': 'D', 'æ˜': 'M', 'å¯º': 'S', 'èµµ': 'Z', 'é»˜': 'M', 'ç¬™': 'S', 'è·¯': 'L', 'æ˜Ÿ': 'X', 'æ²³': 'H', 'è€¿': 'G', 'å¼ ': 'Z', 'ä¼Ÿ': 'W', 'é™ˆ': 'C', 'ç¾': 'M', 'å¤§': 'D', 'åŠ›': 'L', 'æµ·': 'H', 'æ£ ': 'T', 'æ›¾': 'Z', 'å°': 'X', 'è´¤': 'X', 'å±•': 'Z', 'åš': 'B', 'å…³': 'G', 'è°·': 'G', 'æ—': 'L', 'è§': 'X', 'å—': 'N', 'æ¹˜': 'X', 'å”': 'T', 'å®›': 'W', 'å¦‚': 'R', 'æ¡¥': 'Q', 'å·': 'C', 'é’Ÿ': 'Z', 'ç™½': 'B', 'é€¸': 'Y', 'å¸†': 'F', 'æµ': 'L', 'æ«': 'F', 'èµ¤': 'C', 'æœ¨': 'M', 'æ™´': 'Q', 'å®«': 'G', 'è‰¯': 'L', 'æ€': 'S', 'å‘¨': 'Z', 'æ°': 'J', 'æ™¨': 'C', 'å…‰': 'G', 'æ›¹': 'C', 'é™†': 'L', 'ç§ƒ': 'T', 'ç ': 'M', 'å­¦': 'X', 'éœ¸': 'B', 'æ‘„': 'S', 'å½±': 'Y', 'åƒ': 'C', 'è´§': 'H', 'è€ƒ': 'K', 'ç ”': 'Y', 'è¿·': 'M', 'èŒ«': 'M', 'è·¯': 'L', 'äºº': 'R', 'è€': 'L', 'æ²¹': 'Y', 'æ–°': 'X', 'ç”Ÿ': 'S', 'æ—': 'P', 'è§‚': 'G' };
        const avatarColors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 'bg-teal-500', 'bg-blue-500', 'bg-indigo-500', 'bg-purple-500', 'bg-pink-500'];

        function getSurnameInitial(name) {
            if (!name || typeof name !== 'string') return '?';
            let cleanName = name.trim();
            if(cleanName.includes('(')) cleanName = cleanName.split('(')[0].trim();
            if(cleanName.includes('-')) {
                const parts = cleanName.split('-');
                if (parts[1] && parts[1].trim()) cleanName = parts[1].trim();
                else cleanName = parts[0].trim();
            }
            let firstChar = cleanName.charAt(0);
            if (/[a-zA-Z]/.test(firstChar)) return firstChar.toUpperCase();
            const initial = pinyinMap[firstChar] || firstChar;
            return initial.toUpperCase();
        }

        function getAvatarColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            const index = Math.abs(hash) % avatarColors.length;
            return avatarColors[index];
        }
        
        function getAvatarSizePx(sizeClass) {
            const match = sizeClass.match(/w-(\d+)/);
            if (match) {
                const sizeUnit = parseInt(match[1], 10);
                if (sizeUnit === 10) return 40; 
                if (sizeUnit === 12) return 48; 
                if (sizeUnit === 14) return 56; 
                if (sizeUnit === 16) return 64; 
                if (sizeUnit === 20) return 80; 
                if (sizeUnit === 6) return 24;  
                if (sizeUnit === 8) return 32;  
                return sizeUnit * 4;
            }
            return 40; 
        }

        function renderAvatar(name, sizeClass = 'w-10 h-10', fontSizeClass = 'text-sm', onClick = '', isVerified = false, customBadgeSize = null, customIconSize = null) {
            const initial = getSurnameInitial(name);
            const bgColor = getAvatarColor(name);
            const clickAttr = onClick ? `onclick="${onClick}"` : '';
            const cursorClass = onClick ? 'cursor-pointer hover:ring-2 hover:ring-primary hover:ring-offset-2 transition-all' : '';
            
            if (!isVerified) {
                return `
                    <div class="relative inline-block">
                        <div class="${sizeClass} ${fontSizeClass} ${cursorClass} rounded-full flex items-center justify-center font-bold text-white flex-shrink-0 ${bgColor} select-none shadow-sm" title="${name}" ${clickAttr}>
                            ${initial}
                        </div>
                    </div>
                `;
            }
            
            const avatarPx = getAvatarSizePx(sizeClass);
            const badgeSizePx = customBadgeSize !== null ? customBadgeSize : Math.max(0, Math.round(avatarPx * 0.40));
            const iconSizePx = customIconSize !== null ? customIconSize : Math.max(0, Math.round(avatarPx * 0.10)); 
            
            let badgeColor = 'bg-yellow-400';
            let badgeTitle = 'è®¤è¯ç”¨æˆ·';
            
            if (isVerified === 'official') {
                badgeColor = 'bg-blue-500';
                badgeTitle = 'å®˜æ–¹è®¤è¯';
            }

            const verifiedBadge = `
                <div class="absolute -bottom-1 -right-1 rounded-full flex items-center justify-center border-2 border-white z-10 ${badgeColor}" 
                    title="${badgeTitle}"
                    style="width: ${badgeSizePx}px; height: ${badgeSizePx}px;">
                    <i class="fa-solid fa-bolt text-white" 
                    style="font-size: ${iconSizePx}px; transform: scale(0.5); transform-origin: center;"></i>
                </div>`;

            return `
                <div class="relative inline-block">
                    <div class="${sizeClass} ${fontSizeClass} ${cursorClass} rounded-full flex items-center justify-center font-bold text-white flex-shrink-0 ${bgColor} select-none shadow-sm" title="${name}" ${clickAttr}>
                        ${initial}
                    </div>
                    ${verifiedBadge}
                </div>
            `;
        }
        
        // -------------------------
        // æ•°æ®å˜é‡åˆå§‹åŒ– (æ•°æ®å°†åœ¨ loadData ä¸­åŠ è½½)
        // -------------------------

        let postsData = [];
        let treeHoleData = [];
        let topicPostsData = {};
        let topicsMetadata = {};
        let marketItems = [];
        const userStats = { // å½“å‰ç”¨æˆ·çš„æ¨¡æ‹Ÿæ•°æ®
             sign: "è¿™é‡Œæ˜¯ä¸ªäººç­¾åï¼Œçƒ­çˆ±ç”Ÿæ´»ï¼Œçƒ­çˆ±æ ¡å›­ã€‚" 
        };

        // -------------------------
        // æ ¸å¿ƒä¸šåŠ¡çŠ¶æ€
        // -------------------------

        let expandedReplies = {};
        let currentCommentSortOrder = 'hot'; 
        let currentFeedSortOrder = 'hot';   
        let activePostId = null;
        let currentSearchQuery = '';
        let currentMarketCategory = 'all'; 
        let activeTopicId = null;
        let currentTopicSortOrder = 'hot';
        let postStack = [];
        let returnViewId = 'main-feed-view';
        let now = Date.now();

        // -------------------------
        // æ•°æ®åŠ è½½é€»è¾‘ (AJAX Fetch)
        // -------------------------

        async function loadData() {
            try {
                // å°è¯•è·å–åŒçº§ç›®å½•ä¸‹çš„ campus_data.json
                const response = await fetch('campus_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // æ›´æ–°å…¨å±€æ—¶é—´åŸºå‡†
                now = Date.now();

                // è¿˜åŸæ•°æ®å¹¶å¤„ç†æ—¶é—´æˆ³
                // JSON ä¸­å­˜å‚¨çš„æ˜¯ offset (è·ç¦»ç°åœ¨å¤šä¹…)ï¼Œéœ€è¦è¿˜åŸä¸ºç»å¯¹æ—¶é—´æˆ³ä»¥ä¾¿æ’åº
                if (data.postsData) {
                    postsData = data.postsData.map(post => {
                        post.timestamp = now - (post.timestampOffset || 0);
                        // å¤„ç†è¯„è®ºæ—¶é—´æˆ³ (å¦‚æœéœ€è¦)
                        if (post.commentList) {
                            post.commentList.forEach(c => {
                                // ç®€å•å¤„ç†ï¼šå¦‚æœæ²¡æœ‰ offsetï¼Œè¿™é‡Œæš‚æ—¶ä¸åšè½¬æ¢ï¼Œä½¿ç”¨åŸå§‹æ—¶é—´å­—ç¬¦ä¸²å±•ç¤º
                            });
                        }
                        return post;
                    });
                }

                if (data.treeHoleData) treeHoleData = data.treeHoleData;
                
                if (data.topicPostsData) {
                    topicPostsData = {};
                    for (const key in data.topicPostsData) {
                        topicPostsData[key] = data.topicPostsData[key].map(post => {
                            post.timestamp = now - (post.timestampOffset || 0);
                            return post;
                        });
                    }
                }

                if (data.topicsMetadata) topicsMetadata = data.topicsMetadata;
                if (data.marketItems) marketItems = data.marketItems;

                console.log("Data loaded successfully:", { posts: postsData.length });
                
                // ç§»é™¤åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
                const feedLoadingEl = document.querySelector('#post-feed .text-center');
                if(feedLoadingEl) feedLoadingEl.remove();
                
                // æ˜¾ç¤ºâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
                document.getElementById('feed-loading-state').classList.remove('hidden');

            } catch (error) {
                console.error("Failed to load data:", error);
                const feedEl = document.getElementById('post-feed');
                if(feedEl) {
                    feedEl.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center text-red-600">
                        <i class="fa-solid fa-triangle-exclamation text-3xl mb-3"></i>
                        <h3 class="font-bold mb-2">æ— æ³•åŠ è½½æ•°æ®</h3>
                        <p class="text-sm">è¯·ç¡®ä¿ <code>campus_data.json</code> æ–‡ä»¶å­˜åœ¨äºåŒä¸€ç›®å½•ä¸‹ã€‚</p>
                        <p class="text-xs mt-2 opacity-70">æ³¨æ„ï¼šç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶å¯èƒ½å› æµè§ˆå™¨è·¨åŸŸç­–ç•¥(CORS)å¯¼è‡´åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨ (Local Server) è¿è¡Œã€‚</p>
                        <button onclick="location.reload()" class="mt-4 bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-full text-sm font-bold transition-colors">åˆ·æ–°é‡è¯•</button>
                    </div>`;
                }
            }
        }

        // -------------------------
        // ä¸šåŠ¡é€»è¾‘å‡½æ•° (ä¿æŒåŸæ ·)
        // -------------------------

        function processContentLinks(text) {
            if (!text) return "";
            function findPostById(id) {
                let post = postsData.find(p => p.id === id);
                if (post) return post;
                post = treeHoleData.find(p => p.id === id);
                if (post) return post;
                for (const topicId in topicPostsData) {
                    post = topicPostsData[topicId].find(p => p.id === id);
                    if (post) return post;
                }
                post = marketItems.find(p => p.id === id);
                if (post) return post;
                return null;
            }
            return text.replace(/>>(\d+)/g, (match, idStr) => {
                const id = parseInt(idStr);
                const post = findPostById(id);
                if (post) {
                    let displayText = post.title;
                    if (!displayText && post.content) displayText = post.content.substring(0, 10) + "...";
                    else if (!displayText) displayText = "æŸ¥çœ‹è¯¦æƒ…";
                    if (displayText.length > 12) displayText = displayText.substring(0, 12) + "...";
                    return `<span class="text-primary font-medium cursor-pointer hover:underline bg-blue-50 px-1.5 py-0.5 rounded mx-1 select-none text-xs align-baseline inline-flex items-center gap-1" onclick="event.stopPropagation(); openPost(${id})"><i class="fa-solid fa-link text-[10px]"></i>${displayText}</span>`;
                } else {
                    return `<span class="text-gray-400 font-mono bg-gray-100 px-1 rounded mx-0.5 select-none text-xs">#${id} (æœªçŸ¥)</span>`;
                }
            });
        }

        window.toggleCommentExpand = function(id) {
            const textEl = document.getElementById(`comment-text-${id}`);
            const btnEl = document.getElementById(`comment-btn-${id}`);
            if (!textEl || !btnEl) return;
            if (textEl.classList.contains('line-clamp-3')) {
                textEl.classList.remove('line-clamp-3');
                btnEl.innerText = 'æ”¶èµ·';
            } else {
                textEl.classList.add('line-clamp-3');
                btnEl.innerText = 'å±•å¼€';
            }
        }

        window.toggleTreeHoleExpand = function(id) {
            const textEl = document.getElementById(`tree-text-${id}`);
            const btnEl = document.getElementById(`tree-btn-${id}`);
            if (!textEl || !btnEl) return;
            if (textEl.classList.contains('line-clamp-4')) {
                textEl.classList.remove('line-clamp-4');
                btnEl.innerText = 'æ”¶èµ·';
            } else {
                textEl.classList.add('line-clamp-4');
                btnEl.innerText = 'å±•å¼€å…¨æ–‡';
            }
        }

        function handleSearch(query) {
            currentSearchQuery = query.trim();
            renderPosts();
            const titleEl = document.getElementById('feed-title');
            const loadMoreEl = document.getElementById('feed-loading-state');
            if (currentSearchQuery) {
                titleEl.innerText = `æœç´¢: "${currentSearchQuery}"`;
                if(loadMoreEl) loadMoreEl.classList.add('hidden');
            } else {
                titleEl.innerText = 'æœ€æ–°åŠ¨æ€';
                if(loadMoreEl) loadMoreEl.classList.remove('hidden');
            }
        }
        
        function switchTopicSortOrder(order) {
            if (currentTopicSortOrder === order) return;
            currentTopicSortOrder = order;
            const hotBtn = document.getElementById('topic-sort-hot');
            const newBtn = document.getElementById('topic-sort-new');
            const activeClass = "py-4 text-sm font-bold text-gray-900 border-b-2 border-gray-900 cursor-pointer";
            const inactiveClass = "py-4 text-sm font-medium text-gray-500 hover:text-gray-900 transition-colors cursor-pointer";
            if (order === 'hot') {
                hotBtn.className = activeClass;
                newBtn.className = inactiveClass;
            } else {
                hotBtn.className = inactiveClass;
                newBtn.className = activeClass;
            }
            renderTopicPosts();
        }

        function renderTopicPosts() {
            if (!activeTopicId || !topicPostsData[activeTopicId]) return;
            const posts = topicPostsData[activeTopicId];
            const sorted = [...posts];
            if (currentTopicSortOrder === 'hot') sorted.sort((a, b) => (b.heatValue || 0) - (a.heatValue || 0));
            else sorted.sort((a, b) => b.timestamp - a.timestamp); 
            renderPostList('topic-posts-feed', sorted);
        }

        function switchFeedSortOrder(order) {
            if (currentFeedSortOrder === order) return;
            currentFeedSortOrder = order;
            const hotBtn = document.getElementById('feed-sort-hot');
            const newBtn = document.getElementById('feed-sort-new');
            const activeClass = "font-bold text-gray-900 cursor-pointer transition-colors flex items-center gap-1";
            const inactiveClass = "cursor-pointer text-gray-400 hover:text-gray-900 transition-colors flex items-center gap-1";
            if (order === 'hot') {
                hotBtn.className = activeClass;
                newBtn.className = inactiveClass;
                hotBtn.querySelector('i').classList.remove('text-gray-400');
                hotBtn.querySelector('i').classList.add('text-red-500');
            } else {
                hotBtn.className = inactiveClass;
                newBtn.className = activeClass;
                hotBtn.querySelector('i').classList.remove('text-red-500');
                hotBtn.querySelector('i').classList.add('text-gray-400');
            }
            renderPosts();
        }

        function getSortedPosts() {
            let filtered = postsData;
            if (currentSearchQuery) {
                const lowerQuery = currentSearchQuery.toLowerCase();
                filtered = postsData.filter(p => p.title.toLowerCase().includes(lowerQuery) || p.user.toLowerCase().includes(lowerQuery));
            } else {
                filtered = postsData.filter(p => p.isPublic !== false);
            }
            const sorted = [...filtered];
            if (currentFeedSortOrder === 'hot') return sorted.sort((a, b) => (b.heatValue || 0) - (a.heatValue || 0));
            else return sorted.sort((a, b) => b.timestamp - a.timestamp);
        }

        function renderTreeHolePosts() {
            const container = document.getElementById('tree-hole-feed');
            if(!container) return;
            let html = '';
            treeHoleData.forEach(post => {
                const isLongContent = post.content.length > 100;
                html += `
                <article class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow select-none animate-fade-in relative overflow-hidden">
                    <i class="fa-solid fa-quote-left absolute top-4 right-4 text-4xl text-gray-50 opacity-50"></i>
                    <div class="flex items-center gap-3 mb-3 relative z-10">
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-user-secret"></i></div>
                        <div><h4 class="text-sm font-bold text-gray-700 leading-none">${post.user}</h4><div class="text-xs text-gray-400 mt-1">${post.time}</div></div>
                    </div>
                    <div class="relative z-10 mb-4">
                        <p id="tree-text-${post.id}" class="text-gray-600 text-base leading-relaxed font-medium ${isLongContent ? 'line-clamp-4' : ''}">${post.content}</p>
                        ${isLongContent ? `<button id="tree-btn-${post.id}" onclick="toggleTreeHoleExpand(${post.id})" class="text-xs text-treehole font-bold hover:underline mt-2 cursor-pointer">å±•å¼€å…¨æ–‡</button>` : ''}
                    </div>
                    <div class="flex items-center justify-end border-t border-gray-50 pt-3 relative z-10">
                         <button class="group flex items-center gap-2 text-gray-500 hover:text-emerald-500 transition-colors" onclick="handleLike(this)"><i class="fa-regular fa-heart text-lg like-anim group-hover:scale-110"></i><span class="text-xs font-medium">${post.likes}</span></button>
                    </div>
                </article>`;
            });
            container.innerHTML = html;
        }

        function filterMarket(category) {
            currentMarketCategory = category;
            const buttons = document.querySelectorAll('.market-tab-btn');
            buttons.forEach(btn => {
                if (btn.getAttribute('data-category') === category) btn.className = "market-tab-btn flex-shrink-0 bg-market text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-sm shadow-orange-200 transition-colors";
                else btn.className = "market-tab-btn flex-shrink-0 bg-white border border-gray-200 text-gray-600 px-4 py-1.5 rounded-full text-sm font-medium hover:border-market hover:text-market transition-colors";
            });
            renderMarketItems();
        }

        function handleMarketFavorite(btn) {
            const icon = btn.querySelector('i');
            if (icon.classList.contains('fa-regular')) {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid', 'text-yellow-500', 'like-anim');
                setTimeout(() => icon.classList.remove('like-anim'), 200);
            } else {
                icon.classList.remove('fa-solid', 'text-yellow-500');
                icon.classList.add('fa-regular');
            }
        }

        function renderMarketItems() {
            const container = document.getElementById('market-feed');
            if (!container) return;
            let filteredItems = marketItems;
            if (currentMarketCategory !== 'all') filteredItems = marketItems.filter(item => item.tag === currentMarketCategory);
            if (filteredItems.length === 0) {
                container.innerHTML = `<div class="col-span-2 md:col-span-3 text-center py-12 text-gray-400"><i class="fa-solid fa-box-open text-4xl mb-3 opacity-30"></i><p class="text-sm">è¯¥åˆ†ç±»ä¸‹æš‚æ— å•†å“</p></div>`;
                return;
            }
            let html = '';
            filteredItems.forEach(item => {
                const avatarHtml = renderAvatar(item.user, 'w-6 h-6', 'text-xs', '', item.isVerified, 12, 10);
                const isBuying = item.status === 'buying';
                const priceColor = isBuying ? 'text-blue-500' : 'text-market';
                const pricePrefix = isBuying ? 'é¢„ç®— ' : 'Â¥';
                html += `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all group animate-fade-in">
                    <div class="h-32 bg-gray-100 relative overflow-hidden">
                        <img src="${item.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy" alt="Image">
                        ${isBuying ? '<div class="absolute top-2 right-2 bg-blue-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">æ±‚è´­</div>' : ''}
                    </div>
                    <div class="p-3">
                        <h4 class="text-sm font-bold text-gray-900 line-clamp-2 h-10 mb-2 leading-snug">${item.title}</h4>
                        <div class="flex items-center justify-between mb-2">
                            <span class="${priceColor} font-bold text-sm">${pricePrefix}<span class="text-lg">${item.price}</span></span>
                            <span class="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">${item.tag}</span>
                        </div>
                        <div class="flex items-center justify-between border-t border-gray-50 pt-2">
                            <div class="flex items-center gap-1.5 group/avatar relative">
                                <div>
                                    ${avatarHtml}
                                </div>
                                <span class="text-xs text-gray-500 truncate max-w-[60px]">${item.user}</span>
                            </div>
                            <button class="text-gray-400 hover:text-yellow-500 transition-colors p-1" onclick="handleMarketFavorite(this)"><i class="fa-regular fa-star text-lg"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function updateNavState(activeId) {
            const navIds = ['nav-square', 'nav-treehole', 'nav-market'];
            const mobileNavIds = ['nav-home-mobile', 'nav-treehole-mobile', 'nav-market-mobile'];
            navIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.classList.remove('text-primary', 'font-bold'); el.classList.add('text-gray-600'); }
            });
             mobileNavIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.classList.remove('text-primary'); el.classList.add('text-gray-500'); }
            });
            const activeEl = document.getElementById(activeId);
            if(activeEl) { activeEl.classList.remove('text-gray-600'); activeEl.classList.add('text-primary', 'font-bold'); }
            const mobileActiveEl = document.getElementById(activeId === 'nav-square' ? 'nav-home-mobile' : (activeId === 'nav-treehole' ? 'nav-treehole-mobile' : 'nav-market-mobile'));
            if(mobileActiveEl) { mobileActiveEl.classList.remove('text-gray-500'); mobileActiveEl.classList.add('text-primary'); }
        }

        function hideAllViews() {
            ['main-feed-view', 'post-detail-view', 'user-profile-view', 'topic-detail-view', 'tree-hole-view', 'market-view'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.classList.add('hidden'); el.classList.remove('flex'); }
            });
        }

        function openFeed() {
            hideAllViews();
            document.getElementById('main-feed-view').classList.remove('hidden');
            updateNavState('nav-square');
            window.scrollTo({ top: 0, behavior: 'instant' });
            renderPosts(); 
        }

        function openTreeHole() {
            hideAllViews();
            const view = document.getElementById('tree-hole-view');
            view.classList.remove('hidden');
            view.classList.add('flex');
            updateNavState('nav-treehole');
            renderTreeHolePosts();
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        function openMarket() {
            hideAllViews();
            const view = document.getElementById('market-view');
            view.classList.remove('hidden');
            view.classList.add('flex');
            updateNavState('nav-market');
            filterMarket('all');
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        function openProfile() {
            hideAllViews();
            const view = document.getElementById('user-profile-view');
            view.classList.remove('hidden');
            view.classList.add('flex');
            const profileAvatarContainer = document.getElementById('profile-avatar-container');
            const bigAvatar = renderAvatar('User', 'w-20 h-20', 'text-3xl', '', false, 32, 20); 
            profileAvatarContainer.innerHTML = bigAvatar.replace('rounded-full', 'rounded-full border-4 border-white');
            const myPosts = postsData.filter(p => p.user === 'User');
            renderPostList('profile-posts-list', myPosts);
            document.getElementById('profile-stats-posts').innerText = myPosts.length;
            const totalLikes = myPosts.reduce((sum, p) => sum + p.likes, 0);
            document.getElementById('profile-stats-likes').innerText = totalLikes;
            window.scrollTo({ top: 0, behavior: 'instant' });

            const profileSignEl = document.getElementById('profile-sign');
            if (profileSignEl) {
                profileSignEl.innerHTML = userStats.sign; 
            }

            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        function openTopic(topicId) {
            if (!topicsMetadata[topicId]) return;
            activeTopicId = topicId;
            currentTopicSortOrder = 'hot'; 
            hideAllViews();
            const view = document.getElementById('topic-detail-view');
            view.classList.remove('hidden');
            view.classList.add('flex');
            const metadata = topicsMetadata[topicId];
            const topicHeaderContainer = document.getElementById('topic-header-container');
            const hotBtnClass = "py-4 text-sm font-bold text-gray-900 border-b-2 border-gray-900 cursor-pointer";
            const newBtnClass = "py-4 text-sm font-medium text-gray-500 hover:text-gray-900 transition-colors cursor-pointer";
            topicHeaderContainer.innerHTML = `<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative"><div class="h-32 bg-gradient-to-r ${metadata.gradient} relative"><button onclick="closeTopic()" class="absolute top-4 left-4 w-8 h-8 bg-black/20 hover:bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white transition-colors z-10"><i class="fa-solid fa-arrow-left"></i></button></div><div class="px-6 pb-6 -mt-8 relative z-10"><div class="w-16 h-16 bg-white rounded-xl shadow-md flex items-center justify-center text-3xl mb-3">${metadata.icon}</div><h1 class="text-2xl font-bold text-gray-900 mb-2">${metadata.title}</h1><p class="text-gray-600 text-sm leading-relaxed mb-4">${metadata.desc}</p><div class="flex items-center gap-6 text-xs text-gray-500"><span class="flex items-center gap-1"><i class="fa-solid fa-fire text-red-500"></i> ${metadata.heat} çƒ­åº¦</span><span>${metadata.discuss} è®¨è®º</span><span>${metadata.time} åˆ›å»º</span></div></div></div>`;
            const sortContainer = document.querySelector('#topic-detail-view .border-b');
            if(sortContainer) {
                sortContainer.innerHTML = `<button id="topic-sort-hot" onclick="switchTopicSortOrder('hot')" class="${hotBtnClass}">çƒ­é—¨</button><button id="topic-sort-new" onclick="switchTopicSortOrder('new')" class="${newBtnClass}">å®æ—¶</button>`;
            }
            renderTopicPosts();
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        function closeProfile() { openFeed(); }
        function closeTopic() { openFeed(); }
        function closePost() { 
            document.getElementById('post-detail-view').classList.add('hidden');
            document.getElementById('main-feed-view').classList.remove('hidden');
        }

        let hideTimer;
        const popover = document.getElementById('user-popover');

        function generateUserStats(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            hash = Math.abs(hash);
            
            const randomStats = {
                level: (hash % 6) + 1,
                following: (hash % 200) + 10,
                fans: (hash % 5000) + 100,
                likes: (hash % 10000) + 500,
                sign: [
                    "ç”Ÿæ´»åŸæœ¬æ²‰é—·ï¼Œä½†è·‘èµ·æ¥å°±æœ‰é£ã€‚", 
                    "ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·ã€‚", 
                    "ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒé¸­ï¼", 
                    "Studying hard...", 
                    "çº¯è·¯äººï¼Œä¸è¯„ä»·ã€‚",
                    "è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å†™ã€‚"
                ][hash % 6]
            };

            let post = postsData.find(p => p.user === name);
            if (post && post.userStats) {
                return { ...randomStats, ...post.userStats };
            }
            
            for (const topicId in topicPostsData) {
                post = topicPostsData[topicId].find(p => p.user === name);
                if (post && post.userStats) {
                    return { ...randomStats, ...post.userStats };
                }
            }

            let marketItem = marketItems.find(i => i.user === name);
            if (marketItem && marketItem.userStats) {
                return { ...randomStats, ...marketItem.userStats };
            }

            return randomStats;
        }

        function showUserCard(element, name, isVerified) {
            clearTimeout(hideTimer);
            const rect = element.getBoundingClientRect();
            const stats = generateUserStats(name);
            
            document.getElementById('popover-name').innerText = name;
            document.getElementById('popover-following').innerText = stats.following;
            document.getElementById('popover-fans').innerText = stats.fans;
            document.getElementById('popover-likes').innerText = stats.likes;
            document.getElementById('popover-sign').innerHTML = stats.sign;
            
            document.getElementById('popover-avatar-container').innerHTML = renderAvatar(name, 'w-16 h-16', 'text-2xl', '', isVerified, 24, 28);
            
            const levelEl = document.getElementById('popover-level');
            if (stats.level === 'h') {
                levelEl.src = `https://i0.hdslb.com/bfs/seed/jinkela/short/webui/user-profile/img/level_h.svg`;
                levelEl.classList.remove('hidden');
            } else {
                levelEl.src = `https://i0.hdslb.com/bfs/seed/jinkela/short/webui/user-profile/img/level_${stats.level}.svg`;
                levelEl.classList.remove('hidden');
            }

            const triggerCenterX = rect.left + rect.width / 2;
            const triggerCenterY = rect.top + rect.height / 2;
            
            const popoverAvatarOffsetX = 24 + 32;
            const popoverAvatarOffsetY = 24 + 32;
            
            let left = triggerCenterX - popoverAvatarOffsetX + window.scrollX;
            let top = triggerCenterY - popoverAvatarOffsetY + window.scrollY;
            
            popover.style.left = `${left}px`;
            popover.style.top = `${top}px`;
            popover.style.display = 'block';
            
            const animContent = document.getElementById('popover-anim-content');
            const statsContent = document.getElementById('popover-stats');
            const footerContent = document.getElementById('popover-footer');

            animContent.classList.remove('duration-500'); 
            animContent.classList.add('duration-0');
            animContent.style.transform = 'translate(0, 0)'; 
            
            statsContent.classList.remove('duration-500');
            statsContent.classList.add('duration-0');
            statsContent.classList.remove('opacity-100');
            statsContent.classList.add('opacity-0');

            footerContent.classList.remove('duration-500');
            footerContent.classList.add('duration-0');
            footerContent.classList.remove('opacity-100');
            footerContent.classList.add('opacity-0');

            void popover.offsetWidth;

            requestAnimationFrame(() => {
                popover.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                popover.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');

                animContent.classList.remove('duration-0');
                animContent.classList.add('duration-500');
                
                statsContent.classList.remove('duration-0');
                statsContent.classList.add('duration-500');

                footerContent.classList.remove('duration-0');
                footerContent.classList.add('duration-500');

                statsContent.classList.add('opacity-100');
                statsContent.classList.remove('opacity-0');
                footerContent.classList.add('opacity-100');
                footerContent.classList.remove('opacity-0');
            });
        }

        function hideUserCardDelay() {
            hideTimer = setTimeout(() => {
                popover.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                popover.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
            }, 300); 
        }

        function cancelHideUserCard() { 
            clearTimeout(hideTimer);
        }

        function renderPostList(containerId, posts) {
            const feed = document.getElementById(containerId);
            if (!feed) return;
            let html = '';
            if (!posts || posts.length === 0) {
                feed.innerHTML = `<div class="text-center py-12 text-gray-400"><p class="text-sm">æš‚æ— å†…å®¹</p></div>`;
                return;
            }
            posts.forEach(post => {
                const imageHtml = post.images.length > 0 ? `<div class="mt-3 mb-1 rounded-xl overflow-hidden h-48 md:h-64 w-full relative" onclick="event.stopPropagation(); openPost(${post.id})"><img src="${post.images[0]}" class="object-cover w-full h-full hover:scale-105 transition-transform duration-500" loading="lazy" alt="Image"></div>` : '';
                
                let customBadge = null;
                let customIcon = null;
                if (containerId === 'post-feed' || containerId === 'topic-posts-feed') {
                    customBadge = 16;
                    customIcon = 18;
                }

                const avatarHtml = renderAvatar(post.user, 'w-10 h-10', 'text-sm', '', post.isVerified, customBadge, customIcon);
                const clickAction = containerId === 'topic-posts-feed' ? '' : `onclick="openPost(${post.id})"`;
                const cursorStyle = containerId === 'topic-posts-feed' ? 'cursor-default' : 'cursor-pointer hover:shadow-md';
                const safeUsername = post.user.replace(/'/g, "\\'");

                let avatarWrapper = avatarHtml;
                if (containerId !== 'post-feed') {
                     const isVerifiedParam = typeof post.isVerified === 'string' ? `'${post.isVerified}'` : (post.isVerified || false);
                     avatarWrapper = `<div class="group/avatar relative" onmouseenter="showUserCard(this, '${safeUsername}', ${isVerifiedParam})" onmouseleave="hideUserCardDelay()">
                                ${avatarHtml}
                            </div>`;
                }
                
                html += `
                <article ${clickAction} class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 ${cursorStyle} transition-shadow select-none animate-fade-in relative z-0">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3 relative">
                            ${avatarWrapper}
                            <div><h4 class="text-[15px] font-bold text-gray-900 leading-none my-1">${post.user}</h4><div class="flex items-center gap-2 mt-1"><span class="text-xs text-gray-400">${post.time}</span><span class="w-1 h-1 bg-gray-300 rounded-full"></span><span class="text-xs text-primary bg-blue-50 px-2 py-0.5 rounded-full font-medium -my-1">${post.tag}</div></div></div>
                        <button class="text-gray-300 hover:text-gray-600 p-2 rounded-full hover:bg-gray-50" onclick="event.stopPropagation()"><i class="fa-solid fa-ellipsis"></i></button>
                    </div>
                    <div class="mb-4">
                        <h2 class="text-lg md:text-xl font-bold text-gray-900 mb-2 leading-tight hover:text-primary transition-colors">${post.title}</h2>
                        <div class="text-gray-600 text-sm md:text-base leading-relaxed line-clamp-3">${post.content}</div>${imageHtml}
                    </div>
                    <div class="flex items-center justify-between border-t border-gray-50 pt-3">
                        <div class="flex gap-6">
                            <button class="group flex items-center gap-2 text-gray-500 hover:text-red-500 transition-colors" onclick="event.stopPropagation(); handleLike(this)"><i class="fa-regular fa-heart text-lg like-anim group-hover:scale-110"></i><span class="text-xs font-medium">${post.likes}</span></button>
                            <button class="group flex items-center gap-2 text-gray-500 hover:text-blue-500 transition-colors"><i class="fa-regular fa-comment text-lg group-hover:scale-110 transition-transform"></i><span class="text-xs font-medium">${post.comments}</span></button>
                            <button class="group flex items-center gap-2 text-gray-500 hover:text-green-500 transition-colors" onclick="event.stopPropagation()"><i class="fa-solid fa-share nodes text-lg group-hover:scale-110 transition-transform"></i></button>
                        </div>
                        <div class="text-xs text-gray-400 flex items-center gap-1"><i class="fa-solid fa-chart-simple"></i> ${post.views}</div>
                    </div>
                </article>`;
            });
            feed.innerHTML = html;
        }

        function renderCommentsRecursive(comments, postId) {
            if (!comments || comments.length === 0) return '<div class="text-center text-gray-400 py-12 text-sm flex flex-col items-center gap-2"><i class="fa-regular fa-comments text-2xl text-gray-200"></i><span>æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</span></div>';
            const sortedComments = sortComments(comments);
            return sortedComments.map(c => {
                const totalReplies = c.replies ? c.replies.length : 0;
                const isExpanded = expandedReplies[c.id] === true;
                const repliesToShow = isExpanded ? c.replies : (c.replies ? c.replies.slice(0, 2) : []);
                const mainAvatarHtml = renderAvatar(c.user, 'w-10 h-10', 'text-sm', '', c.isVerified);
                const isLongComment = c.content.length > 100;
                const processedContent = processContentLinks(c.content);
                const safeUsername = c.user.replace(/'/g, "\\'");

                const levelIcon = c.level !== undefined ? `<img src="https://i0.hdslb.com/bfs/seed/jinkela/short/webui/user-profile/img/level_${c.level}.svg" class="h-7 w-auto -ml-1 align-middle select-none" alt="Lv${c.level}">` : '';

                let repliesListHtml = repliesToShow.map(r => {
                    const replyAvatarHtml = renderAvatar(r.user, 'w-6 h-6', 'text-xs', '', r.isVerified);
                    const processedReplyContent = processContentLinks(r.content);
                    const safeReplyUsername = r.user.replace(/'/g, "\\'");
                    return `<div class="flex gap-2.5 items-start group relative">
                        <div>${replyAvatarHtml}</div>
                        <div class="flex-1"><div class="text-sm leading-relaxed"><span class="text-xs font-bold ${r.isHost === 1 ? 'text-primary' : 'text-gray-600'} cursor-pointer hover:text-bilibili mr-1">${r.user}</span>${r.to ? `<span class="text-xs text-gray-500">å›å¤ <span class="text-blue-500 cursor-pointer hover:underline">@${r.to}</span> : </span>` : ': '}<span class="text-gray-700 hover:text-gray-900 transition-colors">${processedReplyContent}</span></div><div class="flex items-center gap-4 text-[11px] text-gray-400 mt-1"><span>${r.time}</span><button class="hover:text-bilibili flex items-center gap-1 transition-colors" onclick="handleCommentLike(this)"><i class="fa-regular fa-thumbs-up"></i><span>${r.likes || 0}</span></button><button class="hover:text-bilibili flex items-center gap-1 transition-colors"><i class="fa-regular fa-thumbs-down"></i></button><button class="hover:text-bilibili font-medium opacity-0 group-hover:opacity-100 transition-opacity">å›å¤</button></div></div></div>`;
                }).join('<div class="h-2"></div>');
                let viewMoreLinkHtml = '';
                if (totalReplies > 2) {
                    if (isExpanded) viewMoreLinkHtml = `<div class="mt-2 text-xs pt-1"><span class="text-blue-500 cursor-pointer hover:underline flex items-center gap-1 w-fit" onclick="window.toggleReplies(${postId}, ${c.id})">æ”¶èµ·å›å¤ <i class="fa-solid fa-angle-up text-[10px]"></i></span></div>`;
                    else viewMoreLinkHtml = `<div class="mt-2 text-xs pt-1 flex items-center gap-1"><span class="text-gray-500">å…±${totalReplies}æ¡å›å¤, </span><span class="text-blue-500 cursor-pointer hover:underline flex items-center gap-1" onclick="window.toggleReplies(${postId}, ${c.id})">ç‚¹å‡»æŸ¥çœ‹ <i class="fa-solid fa-angle-right text-[10px]"></i></span></div>`;
                }
                const repliesHtml = totalReplies > 0 ? `<div id="replies-container-${c.id}" class="mt-3 bg-gray-50/80 rounded-lg p-3 space-y-0">${repliesListHtml}${viewMoreLinkHtml}</div>` : '';
                return `<div class="flex gap-4 mb-6 animate-fade-in group">
                    <div class="flex-shrink-0 cursor-pointer hover:scale-105 transition-transform">
                        ${mainAvatarHtml}
                    </div>
                    <div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="text-sm font-bold ${c.isHost === 1 ? 'text-primary' : 'text-gray-600'} cursor-pointer hover:text-bilibili transition-colors">${c.user}</span>${levelIcon}${c.isPinned ? '<span class="text-[10px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded border border-red-100 font-bold select-none ml-2">ç½®é¡¶</span>' : ''}</div><div class="mb-2"><p id="comment-text-${c.id}" class="text-[15px] text-gray-800 leading-relaxed ${isLongComment ? 'line-clamp-3' : ''}">${processedContent}</p>${isLongComment ? `<button id="comment-btn-${c.id}" onclick="toggleCommentExpand(${c.id})" class="text-xs text-primary font-bold hover:underline mt-1">å±•å¼€</button>` : ''}</div><div class="flex items-center gap-5 text-xs text-gray-400"><span>${c.time}</span><button class="flex items-center gap-1.5 hover:text-bilibili transition-colors" onclick="handleCommentLike(this)"><i class="fa-regular fa-thumbs-up text-[13px]"></i><span>${c.likes || 0}</span></button><button class="flex items-center gap-1.5 hover:text-bilibili transition-colors"><i class="fa-regular fa-thumbs-down text-[13px]"></i></button><button class="hover:text-bilibili transition-colors font-medium">å›å¤</button><button class="ml-auto hover:text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-ellipsis-vertical"></i></button></div>${repliesHtml}</div></div><div class="border-b border-gray-50 my-4 last:hidden"></div>`;
            }).join('');
        }

        function openPost(id, isBack = false) {
             let post = postsData.find(p => p.id === id);
             let isTreeHole = false;
             if (!post) { post = treeHoleData.find(p => p.id === id); if (post) isTreeHole = true; }
             if (!post) { for (const topicId in topicPostsData) { const p = topicPostsData[topicId].find(item => item.id === id); if (p) { post = p; break; } } }
             if (!post) post = marketItems.find(p => p.id === id);
             if (!post) return;
             const detailView = document.getElementById('post-detail-view');
             const isCurrentlyViewingPost = !detailView.classList.contains('hidden');
             if (!isCurrentlyViewingPost) {
                 if (!document.getElementById('main-feed-view').classList.contains('hidden')) returnViewId = 'main-feed-view';
                 else if (!document.getElementById('tree-hole-view').classList.contains('hidden')) returnViewId = 'tree-hole-view';
                 else if (!document.getElementById('market-view').classList.contains('hidden')) returnViewId = 'market-view';
                 else if (!document.getElementById('topic-detail-view').classList.contains('hidden')) returnViewId = 'topic-detail-view';
                 else if (!document.getElementById('user-profile-view').classList.contains('hidden')) returnViewId = 'user-profile-view';
                 postStack = []; hideAllViews();
             } else {
                 if (!isBack && activePostId !== null) postStack.push(activePostId);
             }
             activePostId = id; 
             if (!isTreeHole && post.commentList) { postsData.forEach(p => { if(p.commentList) { p.commentList.forEach(c => { expandedReplies[c.id] = false; }); } }); }
             detailView.classList.remove('hidden');
             const authorAvatarHtml = isTreeHole ? `<div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xl"><i class="fa-solid fa-user-secret"></i></div>` : renderAvatar(post.user, 'w-12 h-12', 'text-base', '', post.isVerified, 20, 22);
             const imageHtml = post.images && post.images.length > 0 ? `<img src="${post.images[0]}" class="w-full rounded-xl mb-6 shadow-sm" alt="Image">` : '';
             const commentsSection = isTreeHole ? `<div class="py-12 text-center text-gray-400 bg-gray-50 rounded-xl my-8 border border-gray-100 border-dashed"><i class="fa-solid fa-comment-slash text-3xl mb-2 opacity-50"></i><p class="text-sm">æ ‘æ´å†…å®¹ Â· ç¦è¯„ä¿æŠ¤</p></div>` : (() => {
                    const commentsToRender = post.commentList || [];
                    const commentsHtml = renderCommentsRecursive(commentsToRender, id); 
                    const hotClass = currentCommentSortOrder === 'hot' ? "font-bold text-gray-900 cursor-pointer transition-colors" : "cursor-pointer hover:text-gray-900 transition-colors";
                    const newClass = currentCommentSortOrder === 'new' ? "font-bold text-gray-900 cursor-pointer transition-colors" : "cursor-pointer hover:text-gray-900 transition-colors";
                    return `<div class="mb-20"><div class="flex items-center justify-between mb-6"><h3 class="font-bold text-gray-900 text-lg">å…¨éƒ¨è¯„è®º <span class="text-gray-400 text-base font-normal">(${commentsToRender.length})</span></h3><div class="flex gap-4 text-sm text-gray-500"><span id="sort-hot-btn" class="${hotClass}" onclick="switchCommentSortOrder('hot')">æœ€çƒ­</span><span id="sort-new-btn" class="${newClass}" onclick="switchCommentSortOrder('new')">æœ€æ–°</span></div></div><div id="comments-list">${commentsHtml}</div></div>`;
                })();
             
             const safeUsername = post.user ? post.user.replace(/'/g, "\\'") : '';
             const authorIsVerifiedParam = typeof post.isVerified === 'string' ? `'${post.isVerified}'` : (post.isVerified || false);
             const avatarWrapper = isTreeHole ? authorAvatarHtml : `<div class="group/avatar relative" onmouseenter="showUserCard(this, '${safeUsername}', ${authorIsVerifiedParam})" onmouseleave="hideUserCardDelay()">${authorAvatarHtml}</div>`;

            let commentPlaceholder = "å‘ä¸€æ¡å‹å–„çš„è¯„è®º...";
            let isInputDisabled = false;
            let inputClasses = "w-full bg-gray-100 rounded-full pl-4 pr-10 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all hover:bg-gray-200 focus:bg-white";

            if (post.isCommentDisabled) {
                commentPlaceholder = "å½“å‰é¡µé¢è¯„è®ºåŠŸèƒ½å·²å…³é—­";
                isInputDisabled = true;
                inputClasses = "w-full bg-gray-100/50 rounded-full pl-4 pr-10 py-2.5 text-sm cursor-not-allowed text-gray-500 focus:outline-none";
            } else if (post.isCommentModerated) {
                commentPlaceholder = "è¯„è®ºè¢«UPè´´ä¸»ç­›é€‰åï¼Œå¯¹æ‰€æœ‰äººå¯è§";
            }

             const bottomBar = isTreeHole ? `<div class="sticky bottom-0 border-t border-gray-100 bg-white p-3 md:rounded-b-2xl pb-safe flex justify-between items-center px-6"><span class="text-gray-400 text-sm">æ ‘æ´æ¨¡å¼ï¼Œä»…ä¾›æµè§ˆ</span><button class="flex items-center gap-2 text-gray-500 hover:text-emerald-500 transition-colors px-4 py-2 bg-gray-50 rounded-full" onclick="handleLike(this)"><i class="fa-regular fa-heart text-xl"></i><span class="font-bold">${post.likes}</span></button></div>` : `<div class="sticky bottom-0 border-t border-gray-100 bg-white p-3 md:rounded-b-2xl pb-safe">
             <div class="flex gap-2 items-center">
                 <div class="flex-1 relative">
                     <input type="text" placeholder="${commentPlaceholder}" class="${inputClasses}" ${isInputDisabled ? 'disabled' : ''}>
                     <button class="absolute right-2 top-1/2 -translate-y-1/2 w-7 h-7 bg-primary text-white rounded-full flex items-center justify-center text-xs shadow-md hover:scale-105 transition-transform ${isInputDisabled ? 'bg-gray-400 cursor-not-allowed opacity-70 hover:scale-100' : ''}" ${isInputDisabled ? 'disabled' : ''}>
                         <i class="fa-solid fa-paper-plane"></i>
                     </button>
                 </div>
                 <button class="p-2.5 text-gray-400 hover:text-bilibili transition-colors" onclick="handleLike(this)" ${isInputDisabled ? 'disabled' : ''}>
                     <i class="fa-regular fa-thumbs-up text-xl"></i>
                 </button>
                 <button class="p-2.5 text-gray-400 hover:text-yellow-500 transition-colors" ${isInputDisabled ? 'disabled' : ''}>
                     <i class="fa-regular fa-star text-xl"></i>
                 </button>
             </div>
         </div>`;
             const postTitle = post.title || `æ ‘æ´ #${post.id}`;
             const postContent = post.content || "";
             
             detailView.innerHTML = `<div class="sticky top-16 md:top-0 z-20 bg-white/95 backdrop-blur border-b border-gray-100 p-4 flex items-center gap-4 rounded-t-2xl shadow-sm"><button onclick="goBack()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"><i class="fa-solid fa-arrow-left text-gray-600"></i></button><span class="font-bold text-gray-900">${isTreeHole ? 'æ ‘æ´è¯¦æƒ…' : 'å¸–å­è¯¦æƒ…'}</span></div><div class="p-6"><div class="flex items-center gap-3 mb-6">${avatarWrapper}<div><h4 class="font-bold text-gray-900 style="font-size: 16px;">${post.user}</h4><div class="flex items-center gap-2 text-xs text-gray-500"><span>${post.time}</span>${post.tag ? `<span>Â·</span><span class="text-primary">${post.tag}</span>` : ''}</div></div>${!isTreeHole ? '<button class="ml-auto bg-primary/10 text-primary px-4 py-1.5 rounded-full text-xs font-bold hover:bg-primary hover:text-white transition-colors">å…³æ³¨</button>' : ''}</div><article class="prose prose-blue max-w-none mb-8">${isTreeHole ? '' : `<h1 class="text-2xl font-bold text-gray-900 mb-4 leading-snug">${postTitle}</h1>`}<div class="text-gray-700 text-lg leading-relaxed mb-6 font-medium space-y-4">${postContent}</div>${imageHtml}</article>${!isTreeHole ? `<div class="flex items-center justify-between border-y border-gray-100 py-3 mb-8 text-sm text-gray-500"><div class="flex gap-4"><span>é˜…è¯» ${post.views}</span><span>ç‚¹èµ ${post.likes}</span></div><span>ä¸¾æŠ¥</span></div>` : ''}${commentsSection}</div>${bottomBar}`;
        }

        function goBack() {
            if (postStack.length > 0) { const prevId = postStack.pop(); openPost(prevId, true); }
            else { closePostToView(); }
        }

        function closePostToView() {
            const detailView = document.getElementById('post-detail-view');
            detailView.classList.add('hidden');
            const returnView = document.getElementById(returnViewId);
            if (returnView) { returnView.classList.remove('hidden'); if (['user-profile-view', 'topic-detail-view', 'tree-hole-view', 'market-view'].includes(returnViewId)) returnView.classList.add('flex'); }
            else document.getElementById('main-feed-view').classList.remove('hidden');
            activePostId = null;
        }

        function sortComments(comments) {
            const sorted = [...comments];
            return sorted.sort((a, b) => {
                const pinnedA = a.isPinned || 0; const pinnedB = b.isPinned || 0;
                if (pinnedA !== pinnedB) return pinnedB - pinnedA;
                if (currentCommentSortOrder === 'hot') return (b.heatValue || 0) - (a.heatValue || 0);
                else return b.id - a.id; 
            });
        }

        function renderPosts() {
            const sortedPosts = getSortedPosts();
            renderPostList('post-feed', sortedPosts);
        }

        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            const backdrop = document.getElementById('modalBackdrop');
            const panel = document.getElementById('modalPanel');
            if (modal.classList.contains('hidden')) { modal.classList.remove('hidden'); backdrop.classList.add('active'); requestAnimationFrame(() => { setTimeout(() => { panel.classList.remove('scale-95', 'opacity-0'); panel.classList.add('scale-100', 'opacity-100'); }, 50); }); document.body.style.overflow = 'hidden'; }
            else { panel.classList.remove('scale-100', 'opacity-100'); panel.classList.add('scale-95', 'opacity-0'); setTimeout(() => { backdrop.classList.remove('active'); setTimeout(() => { modal.classList.add('hidden'); document.body.style.overflow = ''; }, 500); }, 50); }
        }

        function handleLike(btn) {
            const icon = btn.querySelector('i');
            const countSpan = btn.querySelector('span');
            if(!countSpan) {
                if (icon.classList.contains('fa-regular')) { icon.classList.remove('fa-regular'); icon.classList.add('fa-solid', 'text-bilibili', 'like-anim'); setTimeout(() => icon.classList.remove('like-anim'), 200); }
                else { icon.classList.remove('fa-solid', 'text-bilibili'); icon.classList.add('fa-regular'); }
                return;
            }
            let count = parseInt(countSpan.innerText);
            if (icon.classList.contains('fa-regular')) { icon.classList.remove('fa-regular'); icon.classList.add('fa-solid', 'text-red-500', 'liked'); count++; if(navigator.vibrate) navigator.vibrate(50); }
            else { icon.classList.remove('fa-solid', 'text-red-500', 'liked'); icon.classList.add('fa-regular'); count--; }
            countSpan.innerText = count;
        }

        function handleCommentLike(btn) {
            const icon = btn.querySelector('i');
            const countSpan = btn.querySelector('span');
            let count = parseInt(countSpan.innerText);
            if (icon.classList.contains('fa-regular')) { icon.classList.remove('fa-regular'); icon.classList.add('fa-solid', 'comment-liked'); count++; icon.style.transform = 'scale(1.2)'; setTimeout(() => icon.style.transform = 'scale(1)', 200); }
            else { icon.classList.remove('fa-solid', 'comment-liked'); icon.classList.add('fa-regular'); count--; }
            countSpan.innerText = count;
        }

        function submitPost() {
            const content = document.getElementById('postContent').value;
            if(!content) { showToast('è¯·è¾“å…¥å†…å®¹'); return; }
            toggleModal('postModal');
            document.getElementById('postContent').value = ''; 
            setTimeout(() => { showToast('å‘å¸ƒæˆåŠŸï¼'); window.scrollTo({ top: 0, behavior: 'smooth' }); }, 700);
        }

        let toastTimeout;
        function showToast(msg) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.classList.remove('opacity-0');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
        }

        window.toggleReplies = function(postId, commentId) {
            const isExpanded = expandedReplies[commentId];
            expandedReplies[commentId] = !isExpanded;
            const post = postsData.find(p => p.id === postId);
            const comment = post.commentList.find(c => c.id === commentId);
            if (comment) {
                const totalReplies = comment.replies ? comment.replies.length : 0;
                let repliesToShow = [];
                if (comment.replies && comment.replies.length > 0) {
                    if (expandedReplies[commentId]) {
                        repliesToShow = [...comment.replies].sort((a, b) => a.id - b.id);
                    } else {
                        repliesToShow = [...comment.replies].sort((a, b) => (b.likes || 0) - (a.likes || 0)).slice(0, 2);
                    }
                }

                let repliesListHtml = repliesToShow.map(r => {
                    const replyAvatarHtml = renderAvatar(r.user, 'w-6 h-6', 'text-xs', '', r.isVerified);
                    const processedReplyContent = processContentLinks(r.content);
                    const safeReplyUsername = r.user.replace(/'/g, "\\'");
                    return `<div class="flex gap-2.5 items-start group relative">
                        <div>${replyAvatarHtml}</div>
                        <div class="flex-1"><div class="text-sm leading-relaxed"><span class="text-xs font-bold ${r.isHost === 1 ? 'text-primary' : 'text-gray-600'} cursor-pointer hover:text-bilibili mr-1">${r.user}</span>${r.to ? `<span class="text-xs text-gray-500">å›å¤ <span class="text-blue-500 cursor-pointer hover:underline">@${r.to}</span> : </span>` : ': '}<span class="text-gray-700 hover:text-gray-900 transition-colors">${processedReplyContent}</span></div><div class="flex items-center gap-4 text-[11px] text-gray-400 mt-1"><span>${r.time}</span><button class="hover:text-bilibili flex items-center gap-1 transition-colors" onclick="handleCommentLike(this)"><i class="fa-regular fa-thumbs-up"></i><span>${r.likes || 0}</span></button><button class="hover:text-bilibili flex items-center gap-1 transition-colors"><i class="fa-regular fa-thumbs-down"></i></button><button class="hover:text-bilibili font-medium opacity-0 group-hover:opacity-100 transition-opacity">å›å¤</button></div></div></div>`;
                }).join('<div class="h-2"></div>');
                let viewMoreLinkHtml = '';
                if (totalReplies > 2) {
                    if (expandedReplies[commentId]) viewMoreLinkHtml = `<div class="mt-2 text-xs pt-1"><span class="text-blue-500 cursor-pointer hover:underline flex items-center gap-1 w-fit" onclick="window.toggleReplies(${postId}, ${commentId})">æ”¶èµ·å›å¤ <i class="fa-solid fa-angle-up text-[10px]"></i></span></div>`;
                    else viewMoreLinkHtml = `<div class="mt-2 text-xs pt-1 flex items-center gap-1"><span class="text-gray-500">å…±${totalReplies}æ¡å›å¤, </span><span class="text-blue-500 cursor-pointer hover:underline flex items-center gap-1" onclick="window.toggleReplies(${postId}, ${commentId})">ç‚¹å‡»æŸ¥çœ‹ <i class="fa-solid fa-angle-right text-[10px]"></i></span></div>`;
                }
                const container = document.getElementById(`replies-container-${commentId}`);
                if (container) container.innerHTML = repliesListHtml + viewMoreLinkHtml;
            }
        }

        function renderCommentSection(postId) {
            const post = postsData.find(p => p.id === postId);
            if (!post) return;
            const commentsToRender = post.commentList || [];
            const commentsHtml = renderCommentsRecursive(commentsToRender, postId);
            const listEl = document.getElementById('comments-list');
            if (listEl) listEl.innerHTML = commentsHtml;
        }

        function switchCommentSortOrder(order) {
            if (currentCommentSortOrder === order) return;
            currentCommentSortOrder = order;
            const hotBtn = document.getElementById('sort-hot-btn');
            const newBtn = document.getElementById('sort-new-btn');
            if (order === 'hot') {
                hotBtn.className = "font-bold text-gray-900 cursor-pointer transition-colors";
                newBtn.className = "cursor-pointer hover:text-gray-900 transition-colors";
            } else {
                hotBtn.className = "cursor-pointer hover:text-gray-900 transition-colors";
                newBtn.className = "font-bold text-gray-900 cursor-pointer transition-colors";
            }
            renderCommentSection(activePostId);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // é¡¶éƒ¨å¯¼èˆªä¸ªäººå¤´åƒï¼šä½¿ç”¨é»˜è®¤å°ºå¯¸
            const myAvatar = renderAvatar('User', 'w-8 h-8', 'text-xs', 'openProfile()');
            const desktopContainer = document.getElementById('desktop-user-avatar');
            const mobileContainer = document.getElementById('mobile-user-avatar');
            if(desktopContainer) desktopContainer.innerHTML = myAvatar.replace('w-8 h-8', 'w-8 h-8 cursor-pointer hover:ring-2 hover:ring-primary ring-offset-2 transition-all');
            if(mobileContainer) mobileContainer.innerHTML = myAvatar;

            // æ ¸å¿ƒä¿®æ”¹ï¼šç­‰å¾…æ•°æ®åŠ è½½å®Œæˆåå†æ¸²æŸ“
            await loadData();
            
            renderPosts();
            updateNavState('nav-square'); 
        });

    </script>
</body>
</html>
